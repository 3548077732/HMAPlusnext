# .github/workflows/build-hma-kpm.yml
name: æ‰‹åŠ¨æ„å»º HMA++ Next KPM æ¨¡å—
on:
  workflow_dispatch:
    inputs:
      kernel_version:
        description: "æŒ‡å®šå†…æ ¸ç‰ˆæœ¬ï¼ˆå¦‚ 5.15.0-78-genericï¼Œç•™ç©ºè‡ªåŠ¨åŒ¹é…è¿è¡Œå†…æ ¸ï¼‰"
        required: false
        default: ""
      build_mode:
        description: "æ„å»ºæ¨¡å¼"
        type: choice
        required: true
        default: "release"
        options:
          - release
          - debug

jobs:
  build-kpm:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: ğŸ” æ£€å‡ºä»£ç ï¼ˆåŒ…å«æºç  HMA++.cï¼‰
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: ğŸ“‹ è¾“å‡ºç³»ç»Ÿä¿¡æ¯ï¼ˆä¾¿äºè°ƒè¯•ï¼‰
        run: |
          echo "========================================"
          echo "ç³»ç»Ÿä¿¡æ¯ï¼š"
          uname -a  # è¾“å‡ºå†…æ ¸ç‰ˆæœ¬
          lsb_release -a  # è¾“å‡ºç³»ç»Ÿç‰ˆæœ¬
          echo "========================================"

      - name: ğŸ› ï¸ å®‰è£…ç¼–è¯‘ä¾èµ–ï¼ˆä¿®å¤å†…æ ¸å¤´æ–‡ä»¶åŒ¹é…ï¼‰
        run: |
          sudo apt update -y || { echo "âŒ aptæ›´æ–°å¤±è´¥ï¼"; exit 1; }
          # å®‰è£…æ ¸å¿ƒä¾èµ–
          sudo apt install -y gcc make libelf-dev bc flex bison dwarves wget --fix-missing || { echo "âŒ æ ¸å¿ƒä¾èµ–å®‰è£…å¤±è´¥ï¼"; exit 1; }
          
          # å¤„ç†å†…æ ¸å¤´æ–‡ä»¶ï¼ˆå…³é”®ä¿®å¤ï¼šç¡®ä¿ä¸è¿è¡Œå†…æ ¸ä¸€è‡´ï¼‰
          if [ -n "${{ github.event.inputs.kernel_version }}" ]; then
            # ç”¨æˆ·æŒ‡å®šå†…æ ¸ç‰ˆæœ¬
            KERNEL_VER="${{ github.event.inputs.kernel_version }}"
            sudo apt install -y linux-headers-${KERNEL_VER} linux-image-${KERNEL_VER} || {
              echo "âŒ å®‰è£…æŒ‡å®šå†…æ ¸ç‰ˆæœ¬ï¼ˆ${KERNEL_VER}ï¼‰çš„å¤´æ–‡ä»¶/é•œåƒå¤±è´¥ï¼";
              echo "â„¹ï¸  å¯ç”¨å†…æ ¸ç‰ˆæœ¬ï¼š$(apt-cache search linux-headers- | grep -E '^linux-headers-[0-9.]+-generic' | sort -V | tail -5)";
              exit 1;
            }
          else
            # è‡ªåŠ¨åŒ¹é…è¿è¡Œå†…æ ¸
            KERNEL_VER=$(uname -r)
            sudo apt install -y linux-headers-${KERNEL_VER} || {
              echo "âŒ å®‰è£…å½“å‰å†…æ ¸ï¼ˆ${KERNEL_VER}ï¼‰çš„å¤´æ–‡ä»¶å¤±è´¥ï¼";
              echo "â„¹ï¸  å°è¯•å®‰è£…é€šç”¨å†…æ ¸å¤´æ–‡ä»¶...";
              sudo apt install -y linux-headers-generic || { echo "âŒ é€šç”¨å†…æ ¸å¤´æ–‡ä»¶å®‰è£…å¤±è´¥ï¼"; exit 1; }
              KERNEL_VER="generic"  # é™çº§ä½¿ç”¨é€šç”¨å¤´æ–‡ä»¶
            }
          fi
          echo "âœ… å†…æ ¸å¤´æ–‡ä»¶å®‰è£…å®Œæˆï¼ˆç‰ˆæœ¬ï¼š${KERNEL_VER}ï¼‰"

          # ä¿®å¤ï¼šä½¿ç”¨ KPM æœ€æ–°ç¨³å®šç‰ˆï¼ˆé¿å…æ—§ç‰ˆæœ¬å…¼å®¹é—®é¢˜ï¼‰
          KPM_VERSION="v1.1.0"  # æœ€æ–°ç¨³å®šç‰ˆï¼ˆ2024-12 éªŒè¯å¯ç”¨ï¼‰
          KPM_BIN_URL="https://github.com/chenxyu/kpm/releases/download/${KPM_VERSION}/kpm-linux-amd64"
          wget -q -O /tmp/kpm ${KPM_BIN_URL} || { echo "âŒ ä¸‹è½½ KPM å¤±è´¥ï¼"; exit 1; }
          chmod +x /tmp/kpm
          sudo mv /tmp/kpm /usr/local/bin/
          
          # éªŒè¯ KPM å®‰è£…
          if ! command -v kpm &> /dev/null; then
            echo "âŒ KPM å·¥å…·å®‰è£…å¤±è´¥ï¼"; exit 1;
          fi
          KPM_INSTALLED_VER=$(kpm --version | grep -Eo '[0-9]+\.[0-9]+\.[0-9]+')
          echo "âœ… KPM å·¥å…·å®‰è£…æˆåŠŸï¼ˆç‰ˆæœ¬ï¼š${KPM_INSTALLED_VER}ï¼‰"

      - name: âš™ï¸ é…ç½®æ„å»ºå‚æ•°
        run: |
          if [ "${{ github.event.inputs.build_mode }}" = "debug" ]; then
            echo "EXTRA_CFLAGS=-g -Wall -Wextra" >> $GITHUB_ENV
            echo "ğŸ“Œ å·²å¯ç”¨ debug æ¨¡å¼ï¼ˆä¿ç•™è°ƒè¯•ä¿¡æ¯+è¯¦ç»†è­¦å‘Šï¼‰"
          else
            echo "EXTRA_CFLAGS=-O2 -Wall -Wno-unused-parameter" >> $GITHUB_ENV
            echo "ğŸ“Œ å·²å¯ç”¨ release æ¨¡å¼ï¼ˆä¼˜åŒ–æ€§èƒ½+æŠ‘åˆ¶å†—ä½™è­¦å‘Šï¼‰"
          fi

      - name: ğŸš€ ç¼–è¯‘æºç ï¼ˆè¯¦ç»†æ—¥å¿—æ¨¡å¼ï¼‰
        run: |
          # ç¡®è®¤æºç å­˜åœ¨
          if [ ! -f "HMA++.c" ]; then echo "âŒ æœªæ‰¾åˆ°æºç  HMA++.cï¼"; exit 1; fi
          
          # æ¸…ç†æ—§äº§ç‰©
          make clean || echo "â„¹ï¸  æ— æ—§äº§ç‰©å¯æ¸…ç†"
          
          # ç¼–è¯‘ï¼ˆVERBOSE=1 è¾“å‡ºè¯¦ç»†æ—¥å¿—ï¼Œä¾¿äºæ’æŸ¥é”™è¯¯ï¼‰
          echo "ğŸ“Œ å¼€å§‹ç¼–è¯‘ï¼ˆå†…æ ¸ç‰ˆæœ¬ï¼š${KERNEL_VER}ï¼Œæ„å»ºå‚æ•°ï¼š${{ env.EXTRA_CFLAGS }}ï¼‰"
          make -j$(nproc) VERBOSE=1 EXTRA_CFLAGS="${{ env.EXTRA_CFLAGS }}" || {
            echo "âŒ ç¼–è¯‘å¤±è´¥ï¼æŸ¥çœ‹ä¸Šé¢è¯¦ç»†æ—¥å¿—æ’æŸ¥é—®é¢˜";
            exit 1;
          }
          
          # æ ¡éªŒç¼–è¯‘äº§ç‰©
          if [ ! -f "HMA++.o" ]; then echo "âŒ æœªç”Ÿæˆ HMA++.oï¼"; exit 1; fi
          if [ ! -f "HMA_Next.ko" ]; then echo "âŒ æœªç”Ÿæˆ HMA_Next.koï¼"; exit 1; fi
          
          # éªŒè¯å†…æ ¸æ¨¡å—åˆæ³•æ€§
          echo "ğŸ“Œ å†…æ ¸æ¨¡å—ä¿¡æ¯ï¼š"
          modinfo HMA_Next.ko | grep -E "filename|version|author|license|depends" || {
            echo "âš ï¸  æ¨¡å—ä¿¡æ¯è¯»å–è­¦å‘Šï¼ˆå¯èƒ½ä¸å½±å“ä½¿ç”¨ï¼‰";
          }
          echo "âœ… ç¼–è¯‘æˆåŠŸï¼"

      - name: ğŸ“¦ æ‰“åŒ…ä¸º KPM æ¨¡å—ï¼ˆè¯¦ç»†æ¨¡å¼ï¼‰
        run: |
          echo "ğŸ“Œ å¼€å§‹æ‰“åŒ… KPM æ¨¡å—..."
          make package VERBOSE=1 || { echo "âŒ KPM æ‰“åŒ…å¤±è´¥ï¼"; exit 1; }
          
          # æ ¡éªŒ KPM äº§ç‰©
          if [ ! -f "HMA++.kpm" ]; then echo "âŒ æœªç”Ÿæˆ HMA++.kpmï¼"; exit 1; fi
          
          # éªŒè¯ KPM æ¨¡å—å®Œæ•´æ€§
          kpm info HMA++.kpm || { echo "âš ï¸  KPM æ¨¡å—ä¿¡æ¯è¯»å–è­¦å‘Š"; }
          ls -lH HMA++.kpm  # æ˜¾ç¤ºäº§ç‰©è¯¦æƒ…
          echo "âœ… KPM æ‰“åŒ…æˆåŠŸï¼"

      - name: ğŸ“¤ ä¸Šä¼ äº§ç‰©ï¼ˆå«æ—¥å¿—ï¼‰
        uses: actions/upload-artifact@v4
        with:
          name: HMA++-Next-KPM-${{ github.event.inputs.build_mode }}-${KERNEL_VER}
          path: |
            HMA++.c
            HMA++.o
            HMA_Next.ko
            HMA++.kpm
            Makefile
            ./*.log  # è‹¥æœ‰æ—¥å¿—æ–‡ä»¶ï¼Œä¸€å¹¶ä¸Šä¼ 
          retention-days: 90
          if-no-files-found: error

      - name: ğŸ“ æ„å»ºæŠ¥å‘Š
        run: |
          KERNEL_DISPLAY=$(if [ -n "${{ github.event.inputs.kernel_version }}" ]; then echo "${{ github.event.inputs.kernel_version }}"; else echo "é»˜è®¤ï¼ˆ$(uname -r)ï¼‰"; fi)
          echo "========================================"
          echo "âœ… HMA++ Next KPM æ¨¡å—æ„å»ºæˆåŠŸï¼"
          echo "ğŸ“Œ æºç æ–‡ä»¶ï¼šHMA++.c"
          echo "ğŸ“Œ æ„å»ºæ¨¡å¼ï¼š${{ github.event.inputs.build_mode }}"
          echo "ğŸ“Œ å†…æ ¸ç‰ˆæœ¬ï¼š${KERNEL_DISPLAY}"
          echo "ğŸ“Œ KPM ç‰ˆæœ¬ï¼š${KPM_INSTALLED_VER}"
          echo "ğŸ“Œ æœ€ç»ˆäº§ç‰©ï¼šHMA++.kpmï¼ˆå¤§å°ï¼š$(du -sh HMA++.kpm | awk '{print $1}')ï¼‰"
          echo "========================================"
