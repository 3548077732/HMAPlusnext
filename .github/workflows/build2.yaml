# .github/workflows/build-hma-kpm.yml
name: æ‰‹åŠ¨æ„å»º HMA++ Next KPM æ¨¡å—
on:
  workflow_dispatch:
    inputs:
      kernel_version:
        description: "æŒ‡å®šå†…æ ¸ç‰ˆæœ¬ï¼ˆå¦‚ 5.15.0-78-genericï¼Œç•™ç©ºç”¨é»˜è®¤ï¼‰"
        required: false
        default: ""
      build_mode:
        description: "æ„å»ºæ¨¡å¼"
        type: choice
        required: true
        default: "release"
        options:
          - release
          - debug

jobs:
  build-kpm:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: ğŸ” æ£€å‡ºä»£ç ï¼ˆåŒ…å«æºç  HMA++.cï¼‰
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: ğŸ› ï¸ å®‰è£…ç¼–è¯‘ä¾èµ–
        run: |
          sudo apt update -y
          sudo apt install -y gcc make linux-headers-$(uname -r) libelf-dev bc flex bison dwarves wget
          # ä¿®å¤ï¼šç›´æ¥ä¸‹è½½ KPM é¢„ç¼–è¯‘äºŒè¿›åˆ¶ï¼ˆæ— éœ€å…‹éš†ä»“åº“ï¼Œé¿å…è®¤è¯é—®é¢˜ï¼‰
          KPM_VERSION="v1.0.0"  # ä½¿ç”¨ç¨³å®šç‰ˆæœ¬ï¼ˆå¯æ ¹æ®éœ€è¦æ›´æ–°ï¼‰
          KPM_BIN_URL="https://github.com/chenxyu/kpm/releases/download/${KPM_VERSION}/kpm-linux-amd64"
          wget -q -O /tmp/kpm ${KPM_BIN_URL}
          # èµ‹äºˆæ‰§è¡Œæƒé™å¹¶å®‰è£…
          chmod +x /tmp/kpm
          sudo mv /tmp/kpm /usr/local/bin/
          # éªŒè¯ KPM å®‰è£…æˆåŠŸ
          if ! command -v kpm &> /dev/null; then
            echo "âŒ é”™è¯¯ï¼šKPM å·¥å…·å®‰è£…å¤±è´¥ï¼"
            exit 1
          fi
          echo "âœ… KPM å·¥å…·å®‰è£…æˆåŠŸï¼ˆç‰ˆæœ¬ï¼š$(kpm --version)ï¼‰"
          # å®‰è£…æŒ‡å®šå†…æ ¸å¤´æ–‡ä»¶ï¼ˆè‹¥ç”¨æˆ·è¾“å…¥ï¼‰
          if [ -n "${{ github.event.inputs.kernel_version }}" ]; then
            sudo apt install -y linux-headers-${{ github.event.inputs.kernel_version }} || {
              echo "âŒ é”™è¯¯ï¼šæŒ‡å®šå†…æ ¸ç‰ˆæœ¬çš„å¤´æ–‡ä»¶å®‰è£…å¤±è´¥ï¼"
              exit 1
            }
          fi

      - name: âš™ï¸ é…ç½®æ„å»ºå‚æ•°ï¼ˆæ ¹æ®æ¨¡å¼è°ƒæ•´ï¼‰
        run: |
          if [ "${{ github.event.inputs.build_mode }}" = "debug" ]; then
            echo "EXTRA_CFLAGS=-g" >> $GITHUB_ENV
            echo "ğŸ“Œ å·²å¯ç”¨ debug æ¨¡å¼ï¼Œä¿ç•™è°ƒè¯•ä¿¡æ¯"
          fi

      - name: ğŸš€ ç¼–è¯‘æºç ï¼ˆHMA++.c â†’ .ko æ¨¡å—ï¼‰
        run: |
          # ç¡®è®¤æºç æ–‡ä»¶å­˜åœ¨
          if [ ! -f "HMA++.c" ]; then
            echo "âŒ é”™è¯¯ï¼šæœªæ‰¾åˆ°æºç æ–‡ä»¶ HMA++.cï¼"
            exit 1
          fi
          # æ¸…ç†æ—§äº§ç‰©
          make clean
          # ç¼–è¯‘ï¼ˆä¼ å…¥æ„å»ºå‚æ•°ï¼‰
          make -j$(nproc) EXTRA_CFLAGS="${{ env.EXTRA_CFLAGS }}"
          # æ ¡éªŒç¼–è¯‘äº§ç‰©
          if [ ! -f "HMA++.o" ]; then
            echo "âŒ é”™è¯¯ï¼šHMA++.c ç¼–è¯‘å¤±è´¥ï¼Œæœªç”Ÿæˆ HMA++.oï¼"
            exit 1
          fi
          if [ ! -f "HMA_Next.ko" ]; then
            echo "âŒ é”™è¯¯ï¼šå†…æ ¸æ¨¡å—é“¾æ¥å¤±è´¥ï¼Œæœªç”Ÿæˆ HMA_Next.koï¼"
            exit 1
          fi
          # è¾“å‡ºæ¨¡å—ä¿¡æ¯ï¼ˆéªŒè¯åˆæ³•æ€§ï¼‰
          echo "ğŸ“Œ å†…æ ¸æ¨¡å—ä¿¡æ¯ï¼š"
          modinfo HMA_Next.ko | grep -E "filename|version|author|license"

      - name: ğŸ“¦ æ‰“åŒ…ä¸º KPM æ¨¡å—ï¼ˆHMA++.kpmï¼‰
        run: |
          make package  # è°ƒç”¨ Makefile çš„ package ç›®æ ‡ï¼Œç¡®ä¿äº§ç‰©åä¸€è‡´
          # å†æ¬¡æ ¡éªŒ KPM äº§ç‰©
          if [ ! -f "HMA++.kpm" ]; then
            echo "âŒ é”™è¯¯ï¼šKPM æ‰“åŒ…å¤±è´¥ï¼Œæœªæ‰¾åˆ° HMA++.kpmï¼"
            exit 1
          fi
          # è¾“å‡º KPM æ¨¡å—ä¿¡æ¯
          echo "ğŸ“Œ KPM æ¨¡å—ä¿¡æ¯ï¼š"
          kpm info HMA++.kpm
          ls -l HMA++.kpm  # æ˜¾ç¤ºæ–‡ä»¶å¤§å°å’Œæƒé™ï¼Œä¾¿äºè°ƒè¯•

      - name: ğŸ“¤ ä¸Šä¼ äº§ç‰©ï¼ˆåŒ…å« KPM å’Œä¸­é—´æ–‡ä»¶ï¼‰
        uses: actions/upload-artifact@v4
        with:
          name: HMA++-Next-KPM-${{ github.event.inputs.build_mode }}
          path: |
            HMA++.c  # æºç æ–‡ä»¶ï¼ˆå¯é€‰ï¼Œä¾¿äºå›æº¯ï¼‰
            HMA++.o  # ç¼–è¯‘ä¸­é—´äº§ç‰©
            HMA_Next.ko  # å†…æ ¸æ¨¡å—
            HMA++.kpm  # æœ€ç»ˆ KPM äº§ç‰©
            Makefile  # æ„å»ºé…ç½®
          retention-days: 90
          if-no-files-found: error  # æ— äº§ç‰©æ—¶ç›´æ¥æ ‡è®°å¤±è´¥

      - name: ğŸ“ æ„å»ºæŠ¥å‘Šï¼ˆä¿®å¤è¯­æ³•é”™è¯¯ï¼‰
        run: |
          # ä¿®å¤ï¼šé€šè¿‡ Bash æ¡ä»¶åˆ¤æ–­å¤„ç†å†…æ ¸ç‰ˆæœ¬æ˜¾ç¤º
          if [ -n "${{ github.event.inputs.kernel_version }}" ]; then
            kernel_ver="${{ github.event.inputs.kernel_version }}"
          else
            kernel_ver="é»˜è®¤ï¼ˆ$(uname -r)ï¼‰"
          fi
          echo "========================================"
          echo "âœ… HMA++ Next KPM æ¨¡å—æ„å»ºå®Œæˆï¼"
          echo "ğŸ“Œ æºç æ–‡ä»¶ï¼šHMA++.c"
          echo "ğŸ“Œ æ„å»ºæ¨¡å¼ï¼š${{ github.event.inputs.build_mode }}"
          echo "ğŸ“Œ å†…æ ¸ç‰ˆæœ¬ï¼š$kernel_ver"
          echo "ğŸ“Œ æœ€ç»ˆäº§ç‰©ï¼šHMA++.kpmï¼ˆå¤§å°ï¼š$(du -sh HMA++.kpm | awk '{print $1}')ï¼‰"
          echo "========================================"
