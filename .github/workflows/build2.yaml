# .github/workflows/build-hma-kpm.yml
name: æ‰‹åŠ¨æ„å»º HMA++ Next KPM æ¨¡å—
on:
  workflow_dispatch:
    inputs:
      kernel_version:
        description: "æŒ‡å®šå†…æ ¸ç‰ˆæœ¬ï¼ˆå¦‚ 5.15.0-78-genericï¼Œç•™ç©ºè‡ªåŠ¨åŒ¹é…è¿è¡Œå†…æ ¸ï¼‰"
        required: false
        default: ""
      build_mode:
        description: "æ„å»ºæ¨¡å¼"
        type: choice
        required: true
        default: "release"
        options:
          - release
          - debug

jobs:
  build-kpm:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: ğŸ” æ£€å‡ºä»£ç ï¼ˆåŒ…å«æºç  HMA++.cï¼‰
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: ğŸ“‹ ç½‘ç»œæµ‹è¯•ï¼ˆé•œåƒæºè¿é€šæ€§ï¼‰
        run: |
          echo "========================================"
          echo "ç³»ç»Ÿä¿¡æ¯ï¼š"
          uname -a
          lsb_release -a
          echo "========================================"
          echo "ç½‘ç»œè¿é€šæ€§æµ‹è¯•ï¼ˆç»•å¼€ GitHubï¼Œæµ‹è¯• Giteeï¼‰ï¼š"
          ping -c 2 gitee.com  # æµ‹è¯• Gitee è¿é€šæ€§ï¼ˆé•œåƒæºï¼‰
          if [ $? -ne 0 ]; then
            echo "âš ï¸  Gitee ä¹Ÿæ— æ³•è®¿é—®ï¼Œå°è¯•å…¬å…± DNS è§£æ..."
            echo "nameserver 8.8.8.8" | sudo tee -a /etc/resolv.conf
            ping -c 2 gitee.com || {
              echo "âŒ æ‰€æœ‰é•œåƒæºéƒ½æ— æ³•è®¿é—®ï¼è¯·æ£€æŸ¥ç½‘ç»œç¯å¢ƒï¼";
              exit 1;
            }
          fi
          echo "âœ… Gitee é•œåƒæºè¿é€šæ­£å¸¸ï¼"
          echo "========================================"

      - name: ğŸ› ï¸ å®‰è£…ç¼–è¯‘ä¾èµ–ï¼ˆå†…æ ¸å¤´æ–‡ä»¶+é•œåƒæºé€‚é…ï¼‰
        run: |
          sudo apt update -y || { echo "âŒ aptæ›´æ–°å¤±è´¥ï¼"; exit 1; }
          # å®‰è£…æ ¸å¿ƒä¾èµ–ï¼ˆå« wget+jqï¼‰
          sudo apt install -y gcc make libelf-dev bc flex bison dwarves wget jq --fix-missing || { echo "âŒ æ ¸å¿ƒä¾èµ–å®‰è£…å¤±è´¥ï¼"; exit 1; }
          
          # å¤„ç†å†…æ ¸å¤´æ–‡ä»¶ï¼ˆç¡®ä¿åŒ¹é…ï¼‰
          if [ -n "${{ github.event.inputs.kernel_version }}" ]; then
            KERNEL_VER="${{ github.event.inputs.kernel_version }}"
            sudo apt install -y linux-headers-${KERNEL_VER} linux-image-${KERNEL_VER} || {
              echo "âŒ å®‰è£…æŒ‡å®šå†…æ ¸ï¼ˆ${KERNEL_VER}ï¼‰å¤´æ–‡ä»¶å¤±è´¥ï¼";
              echo "â„¹ï¸  å¯ç”¨å†…æ ¸ç‰ˆæœ¬ï¼š$(apt-cache search linux-headers- | grep -E '^linux-headers-[0-9.]+-generic' | sort -V | tail -5)";
              exit 1;
            }
          else
            KERNEL_VER=$(uname -r)
            sudo apt install -y linux-headers-${KERNEL_VER} || {
              echo "âŒ å®‰è£…å½“å‰å†…æ ¸ï¼ˆ${KERNEL_VER}ï¼‰å¤´æ–‡ä»¶å¤±è´¥ï¼";
              echo "â„¹ï¸  å°è¯•é€šç”¨å†…æ ¸å¤´æ–‡ä»¶...";
              sudo apt install -y linux-headers-generic || { echo "âŒ é€šç”¨å†…æ ¸å¤´æ–‡ä»¶å®‰è£…å¤±è´¥ï¼"; exit 1; }
              KERNEL_VER="generic"
            }
          fi
          echo "âœ… å†…æ ¸å¤´æ–‡ä»¶å®‰è£…å®Œæˆï¼ˆç‰ˆæœ¬ï¼š${KERNEL_VER}ï¼‰"

          # æ ¸å¿ƒä¿®å¤ï¼šå®Œå…¨ä½¿ç”¨ Gitee é•œåƒæºï¼ˆç»•å¼€ GitHubï¼‰
          echo "ğŸ“Œ ä» Gitee é•œåƒè·å– KPMï¼ˆé¿å… GitHub ç½‘ç»œé™åˆ¶ï¼‰..."
          # Gitee é•œåƒæºï¼ˆKPM å®˜æ–¹ GitHub ä»“åº“çš„é•œåƒï¼ŒåŒæ­¥æ›´æ–°ï¼‰
          KPM_GITEE_REPO="https://gitee.com/mirrors/kpm.git"
          KPM_GITEE_RELEASE_URL="https://gitee.com/mirrors/kpm/releases/download/v1.1.0/kpm-linux-amd64"

          # æ–¹æ¡ˆ1ï¼šä¼˜å…ˆä¸‹è½½ Gitee é¢„ç¼–è¯‘äºŒè¿›åˆ¶ï¼ˆæœ€å¿«ï¼‰
          echo "ğŸ“Œ å°è¯•æ–¹æ¡ˆ1ï¼šä¸‹è½½ Gitee é¢„ç¼–è¯‘äºŒè¿›åˆ¶..."
          wget -v -t 3 -T 30 --no-check-certificate -O /tmp/kpm "${KPM_GITEE_RELEASE_URL}" || {
            echo "âš ï¸  æ–¹æ¡ˆ1å¤±è´¥ï¼Œå°è¯•æ–¹æ¡ˆ2ï¼šå…‹éš† Gitee é•œåƒä»“åº“ç¼–è¯‘..."
            # æ–¹æ¡ˆ2ï¼šå…‹éš† Gitee é•œåƒä»“åº“ï¼ˆ--depth 1 å¿«é€Ÿå…‹éš†ï¼‰
            git clone --depth 1 "${KPM_GITEE_REPO}" /tmp/kpm-repo || {
              echo "âš ï¸  æ–¹æ¡ˆ2å¤±è´¥ï¼Œå°è¯•æ–¹æ¡ˆ3ï¼šä½¿ç”¨ Gitee åŠ é€Ÿé“¾æ¥..."
              # æ–¹æ¡ˆ3ï¼šGitee åŠ é€Ÿä¸‹è½½ï¼ˆå¤‡ç”¨é“¾æ¥ï¼‰
              KPM_GITEE_ACCEL_URL="https://gitee.com/mirrors/kpm/raw/v1.1.0/kpm-linux-amd64"
              wget -v -t 3 -T 30 --no-check-certificate -O /tmp/kpm "${KPM_GITEE_ACCEL_URL}" || {
                echo "âŒ æ‰€æœ‰ Gitee æ–¹æ¡ˆéƒ½å¤±è´¥ï¼ä½¿ç”¨ç¦»çº¿å¤‡ç”¨æ–¹æ¡ˆ...";
                # æ–¹æ¡ˆ4ï¼šç¦»çº¿å¤‡ç”¨ï¼ˆç›´æ¥åœ¨ä»“åº“ä¸­æ”¾ç½® KPM äºŒè¿›åˆ¶ï¼Œè¿™é‡Œå‡è®¾å·²ä¸Šä¼ åˆ°ä»“åº“æ ¹ç›®å½•ï¼‰
                if [ -f "./kpm-linux-amd64" ]; then
                  cp ./kpm-linux-amd64 /tmp/kpm
                  chmod +x /tmp/kpm
                else
                  echo "âŒ ç¦»çº¿å¤‡ç”¨æ–¹æ¡ˆä¹Ÿå¤±è´¥ï¼è¯·æ‰‹åŠ¨ä¸Šä¼  kpm-linux-amd64 åˆ°ä»“åº“æ ¹ç›®å½•ï¼";
                  exit 1;
                fi
              }
            }
            # æ–¹æ¡ˆ2åç»­ï¼šç¼–è¯‘ Gitee å…‹éš†çš„æºç 
            if [ -d "/tmp/kpm-repo" ]; then
              cd /tmp/kpm-repo && make -j$(nproc) && sudo mv kpm /usr/local/bin/ || {
                echo "âŒ æ–¹æ¡ˆ2ç¼–è¯‘å¤±è´¥ï¼";
                exit 1;
              }
            fi
          }

          # å®‰è£… KPMï¼ˆæ–¹æ¡ˆ1/3/4 æˆåŠŸåçš„å¤„ç†ï¼‰
          if [ -f "/tmp/kpm" ]; then
            chmod +x /tmp/kpm
            sudo mv /tmp/kpm /usr/local/bin/
          fi

          # éªŒè¯ KPM å®‰è£…
          if ! command -v kpm &> /dev/null; then
            echo "âŒ KPM å·¥å…·å®‰è£…å¤±è´¥ï¼"; exit 1;
          fi
          KPM_INSTALLED_VER=$(kpm --version | grep -Eo '[0-9]+\.[0-9]+\.[0-9]+' || echo "unknown")
          echo "âœ… KPM å·¥å…·å®‰è£…æˆåŠŸï¼ˆç‰ˆæœ¬ï¼š${KPM_INSTALLED_VER}ï¼Œæ¥æºï¼šGitee é•œåƒï¼‰"

      - name: âš™ï¸ é…ç½®æ„å»ºå‚æ•°
        run: |
          if [ "${{ github.event.inputs.build_mode }}" = "debug" ]; then
            echo "EXTRA_CFLAGS=-g -Wall -Wextra" >> $GITHUB_ENV
            echo "ğŸ“Œ å·²å¯ç”¨ debug æ¨¡å¼ï¼ˆä¿ç•™è°ƒè¯•ä¿¡æ¯+è¯¦ç»†è­¦å‘Šï¼‰"
          else
            echo "EXTRA_CFLAGS=-O2 -Wall -Wno-unused-parameter" >> $GITHUB_ENV
            echo "ğŸ“Œ å·²å¯ç”¨ release æ¨¡å¼ï¼ˆä¼˜åŒ–æ€§èƒ½+æŠ‘åˆ¶å†—ä½™è­¦å‘Šï¼‰"
          fi

      - name: ğŸš€ ç¼–è¯‘æºç ï¼ˆè¯¦ç»†æ—¥å¿—ï¼‰
        run: |
          if [ ! -f "HMA++.c" ]; then echo "âŒ æœªæ‰¾åˆ°æºç  HMA++.cï¼"; exit 1; fi
          make clean || echo "â„¹ï¸  æ— æ—§äº§ç‰©å¯æ¸…ç†"
          echo "ğŸ“Œ ç¼–è¯‘å‚æ•°ï¼š${{ env.EXTRA_CFLAGS }}"
          make -j$(nproc) VERBOSE=1 EXTRA_CFLAGS="${{ env.EXTRA_CFLAGS }}" || {
            echo "âŒ ç¼–è¯‘å¤±è´¥ï¼æŸ¥çœ‹è¯¦ç»†æ—¥å¿—æ’æŸ¥é—®é¢˜";
            exit 1;
          }
          if [ ! -f "HMA++.o" ]; then echo "âŒ æœªç”Ÿæˆ HMA++.oï¼"; exit 1; fi
          if [ ! -f "HMA_Next.ko" ]; then echo "âŒ æœªç”Ÿæˆ HMA_Next.koï¼"; exit 1; fi
          echo "ğŸ“Œ æ¨¡å—ä¿¡æ¯ï¼š"
          modinfo HMA_Next.ko | grep -E "filename|version|author|license" || echo "âš ï¸  æ¨¡å—ä¿¡æ¯è¯»å–è­¦å‘Š"
          echo "âœ… ç¼–è¯‘æˆåŠŸï¼"

      - name: ğŸ“¦ æ‰“åŒ… KPM æ¨¡å—
        run: |
          make package VERBOSE=1 || { echo "âŒ æ‰“åŒ…å¤±è´¥ï¼"; exit 1; }
          if [ ! -f "HMA++.kpm" ]; then echo "âŒ æœªç”Ÿæˆ HMA++.kpmï¼"; exit 1; fi
          kpm info HMA++.kpm || echo "âš ï¸  KPM ä¿¡æ¯è¯»å–è­¦å‘Š"
          ls -lH HMA++.kpm
          echo "âœ… æ‰“åŒ…æˆåŠŸï¼"

      - name: ğŸ“¤ ä¸Šä¼ äº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: HMA++-Next-KPM-${{ github.event.inputs.build_mode }}-${KERNEL_VER}
          path: |
            HMA++.c
            HMA++.o
            HMA_Next.ko
            HMA++.kpm
            Makefile
          retention-days: 90
          if-no-files-found: error

      - name: ğŸ“ æ„å»ºæŠ¥å‘Š
        run: |
          KERNEL_DISPLAY=$(if [ -n "${{ github.event.inputs.kernel_version }}" ]; then echo "${{ github.event.inputs.kernel_version }}"; else echo "é»˜è®¤ï¼ˆ$(uname -r)ï¼‰"; fi)
          echo "========================================"
          echo "âœ… HMA++ Next KPM æ¨¡å—æ„å»ºæˆåŠŸï¼"
          echo "ğŸ“Œ æºç ï¼šHMA++.c"
          echo "ğŸ“Œ æ„å»ºæ¨¡å¼ï¼š${{ github.event.inputs.build_mode }}"
          echo "ğŸ“Œ å†…æ ¸ç‰ˆæœ¬ï¼š${KERNEL_DISPLAY}"
          echo "ğŸ“Œ KPM æ¥æºï¼šGitee é•œåƒï¼ˆç‰ˆæœ¬ï¼š${KPM_INSTALLED_VER}ï¼‰"
          echo "ğŸ“Œ äº§ç‰©ï¼šHMA++.kpmï¼ˆå¤§å°ï¼š$(du -sh HMA++.kpm | awk '{print $1}')ï¼‰"
          echo "========================================"
          uname -a  # è¾“å‡ºå†…æ ¸ç‰ˆæœ¬
          lsb_release -a  # è¾“å‡ºç³»ç»Ÿç‰ˆæœ¬
          echo "ç½‘ç»œæµ‹è¯•ï¼š"
          ping -c 2 github.com  # æµ‹è¯• GitHub è¿é€šæ€§
          echo "========================================"

      - name: ğŸ› ï¸ å®‰è£…ç¼–è¯‘ä¾èµ–ï¼ˆä¿®å¤å†…æ ¸å¤´æ–‡ä»¶åŒ¹é…ï¼‰
        run: |
          sudo apt update -y || { echo "âŒ aptæ›´æ–°å¤±è´¥ï¼"; exit 1; }
          # å®‰è£…æ ¸å¿ƒä¾èµ–ï¼ˆå« wget å¢å¼ºå‚æ•°ï¼‰
          sudo apt install -y gcc make libelf-dev bc flex bison dwarves wget jq --fix-missing || { echo "âŒ æ ¸å¿ƒä¾èµ–å®‰è£…å¤±è´¥ï¼"; exit 1; }
          
          # å¤„ç†å†…æ ¸å¤´æ–‡ä»¶ï¼ˆå…³é”®ä¿®å¤ï¼šç¡®ä¿ä¸è¿è¡Œå†…æ ¸ä¸€è‡´ï¼‰
          if [ -n "${{ github.event.inputs.kernel_version }}" ]; then
            KERNEL_VER="${{ github.event.inputs.kernel_version }}"
            sudo apt install -y linux-headers-${KERNEL_VER} linux-image-${KERNEL_VER} || {
              echo "âŒ å®‰è£…æŒ‡å®šå†…æ ¸ç‰ˆæœ¬ï¼ˆ${KERNEL_VER}ï¼‰çš„å¤´æ–‡ä»¶/é•œåƒå¤±è´¥ï¼";
              echo "â„¹ï¸  å¯ç”¨å†…æ ¸ç‰ˆæœ¬ï¼š$(apt-cache search linux-headers- | grep -E '^linux-headers-[0-9.]+-generic' | sort -V | tail -5)";
              exit 1;
            }
          else
            KERNEL_VER=$(uname -r)
            sudo apt install -y linux-headers-${KERNEL_VER} || {
              echo "âŒ å®‰è£…å½“å‰å†…æ ¸ï¼ˆ${KERNEL_VER}ï¼‰çš„å¤´æ–‡ä»¶å¤±è´¥ï¼";
              echo "â„¹ï¸  å°è¯•å®‰è£…é€šç”¨å†…æ ¸å¤´æ–‡ä»¶...";
              sudo apt install -y linux-headers-generic || { echo "âŒ é€šç”¨å†…æ ¸å¤´æ–‡ä»¶å®‰è£…å¤±è´¥ï¼"; exit 1; }
              KERNEL_VER="generic"
            }
          fi
          echo "âœ… å†…æ ¸å¤´æ–‡ä»¶å®‰è£…å®Œæˆï¼ˆç‰ˆæœ¬ï¼š${KERNEL_VER}ï¼‰"

          # æ ¸å¿ƒä¿®å¤ï¼šKPM ä¸‹è½½ï¼ˆé‡è¯•+å¤‡ç”¨æº+è‡ªåŠ¨è·å–æœ€æ–°ç‰ˆæœ¬ï¼‰
          echo "ğŸ“Œ å¼€å§‹è·å– KPM æœ€æ–°ç‰ˆæœ¬..."
          # æ­¥éª¤1ï¼šé€šè¿‡ GitHub API è·å– KPM æœ€æ–° release çš„ä¸‹è½½é“¾æ¥ï¼ˆé¿å…æ‰‹åŠ¨æŒ‡å®šç‰ˆæœ¬ï¼‰
          KPM_REPO="chenxyu/kpm"
          KPM_DOWNLOAD_URL=$(curl -s "https://api.github.com/repos/${KPM_REPO}/releases/latest" | jq -r '.assets[] | select(.name == "kpm-linux-amd64") | .browser_download_url')
          
          if [ -z "${KPM_DOWNLOAD_URL}" ] || [ "${KPM_DOWNLOAD_URL}" == "null" ]; then
            echo "âš ï¸  è·å–æœ€æ–°ç‰ˆæœ¬å¤±è´¥ï¼Œä½¿ç”¨å¤‡ç”¨ç‰ˆæœ¬ v1.1.0"
            KPM_DOWNLOAD_URL="https://github.com/chenxyu/kpm/releases/download/v1.1.0/kpm-linux-amd64"
          fi
          echo "âœ… KPM ä¸‹è½½é“¾æ¥ï¼š${KPM_DOWNLOAD_URL}"

          # æ­¥éª¤2ï¼šä½¿ç”¨ wget é‡è¯•ä¸‹è½½ï¼ˆ5æ¬¡é‡è¯•+å¿½ç•¥è¯ä¹¦+è¯¦ç»†æ—¥å¿—ï¼‰
          echo "ğŸ“Œ å¼€å§‹ä¸‹è½½ KPMï¼ˆæœ€å¤š5æ¬¡é‡è¯•ï¼‰..."
          wget -v -t 5 -T 30 --no-check-certificate -O /tmp/kpm "${KPM_DOWNLOAD_URL}" || {
            echo "âš ï¸  ä¸»æºä¸‹è½½å¤±è´¥ï¼Œå°è¯•å¤‡ç”¨æºï¼ˆå…‹éš†ä»“åº“ï¼‰..."
            # å¤‡ç”¨æ–¹æ¡ˆï¼šå…‹éš† KPM ä»“åº“ï¼ˆä½¿ç”¨ --depth 1 å¿«é€Ÿå…‹éš†ï¼Œé¿å…è®¤è¯é—®é¢˜ï¼‰
            git clone --depth 1 https://github.com/chenxyu/kpm.git /tmp/kpm-repo || {
              echo "âŒ å¤‡ç”¨æºå…‹éš†å¤±è´¥ï¼è¯·æ£€æŸ¥ç½‘ç»œæˆ–æ‰‹åŠ¨å®‰è£… KPMï¼";
              exit 1;
            }
            # ç¼–è¯‘å¤‡ç”¨æºçš„ KPMï¼ˆç¡®ä¿å¯ç”¨ï¼‰
            cd /tmp/kpm-repo && make -j$(nproc) && sudo mv kpm /usr/local/bin/ || {
              echo "âŒ å¤‡ç”¨æºç¼–è¯‘ KPM å¤±è´¥ï¼";
              exit 1;
            }
          }

          # æ­¥éª¤3ï¼šå®‰è£… KPMï¼ˆä¸»æºä¸‹è½½æˆåŠŸçš„æƒ…å†µï¼‰
          if [ -f "/tmp/kpm" ]; then
            chmod +x /tmp/kpm
            sudo mv /tmp/kpm /usr/local/bin/
          fi

          # æ­¥éª¤4ï¼šéªŒè¯ KPM å®‰è£…
          if ! command -v kpm &> /dev/null; then
            echo "âŒ KPM å·¥å…·å®‰è£…å¤±è´¥ï¼"; exit 1;
          fi
          KPM_INSTALLED_VER=$(kpm --version | grep -Eo '[0-9]+\.[0-9]+\.[0-9]+' || echo "unknown")
          echo "âœ… KPM å·¥å…·å®‰è£…æˆåŠŸï¼ˆç‰ˆæœ¬ï¼š${KPM_INSTALLED_VER}ï¼‰"

      - name: âš™ï¸ é…ç½®æ„å»ºå‚æ•°
        run: |
          if [ "${{ github.event.inputs.build_mode }}" = "debug" ]; then
            echo "EXTRA_CFLAGS=-g -Wall -Wextra" >> $GITHUB_ENV
            echo "ğŸ“Œ å·²å¯ç”¨ debug æ¨¡å¼ï¼ˆä¿ç•™è°ƒè¯•ä¿¡æ¯+è¯¦ç»†è­¦å‘Šï¼‰"
          else
            echo "EXTRA_CFLAGS=-O2 -Wall -Wno-unused-parameter" >> $GITHUB_ENV
            echo "ğŸ“Œ å·²å¯ç”¨ release æ¨¡å¼ï¼ˆä¼˜åŒ–æ€§èƒ½+æŠ‘åˆ¶å†—ä½™è­¦å‘Šï¼‰"
          fi

      - name: ğŸš€ ç¼–è¯‘æºç ï¼ˆè¯¦ç»†æ—¥å¿—æ¨¡å¼ï¼‰
        run: |
          if [ ! -f "HMA++.c" ]; then echo "âŒ æœªæ‰¾åˆ°æºç  HMA++.cï¼"; exit 1; fi
          make clean || echo "â„¹ï¸  æ— æ—§äº§ç‰©å¯æ¸…ç†"
          echo "ğŸ“Œ å¼€å§‹ç¼–è¯‘ï¼ˆå†…æ ¸ç‰ˆæœ¬ï¼š${KERNEL_VER}ï¼Œæ„å»ºå‚æ•°ï¼š${{ env.EXTRA_CFLAGS }}ï¼‰"
          make -j$(nproc) VERBOSE=1 EXTRA_CFLAGS="${{ env.EXTRA_CFLAGS }}" || {
            echo "âŒ ç¼–è¯‘å¤±è´¥ï¼æŸ¥çœ‹ä¸Šé¢è¯¦ç»†æ—¥å¿—æ’æŸ¥é—®é¢˜";
            exit 1;
          }
          if [ ! -f "HMA++.o" ]; then echo "âŒ æœªç”Ÿæˆ HMA++.oï¼"; exit 1; fi
          if [ ! -f "HMA_Next.ko" ]; then echo "âŒ æœªç”Ÿæˆ HMA_Next.koï¼"; exit 1; fi
          echo "ğŸ“Œ å†…æ ¸æ¨¡å—ä¿¡æ¯ï¼š"
          modinfo HMA_Next.ko | grep -E "filename|version|author|license|depends" || echo "âš ï¸  æ¨¡å—ä¿¡æ¯è¯»å–è­¦å‘Šï¼ˆå¯èƒ½ä¸å½±å“ä½¿ç”¨ï¼‰"
          echo "âœ… ç¼–è¯‘æˆåŠŸï¼"

      - name: ğŸ“¦ æ‰“åŒ…ä¸º KPM æ¨¡å—ï¼ˆè¯¦ç»†æ¨¡å¼ï¼‰
        run: |
          echo "ğŸ“Œ å¼€å§‹æ‰“åŒ… KPM æ¨¡å—..."
          make package VERBOSE=1 || { echo "âŒ KPM æ‰“åŒ…å¤±è´¥ï¼"; exit 1; }
          if [ ! -f "HMA++.kpm" ]; then echo "âŒ æœªç”Ÿæˆ HMA++.kpmï¼"; exit 1; fi
          kpm info HMA++.kpm || echo "âš ï¸  KPM æ¨¡å—ä¿¡æ¯è¯»å–è­¦å‘Š"
          ls -lH HMA++.kpm
          echo "âœ… KPM æ‰“åŒ…æˆåŠŸï¼"

      - name: ğŸ“¤ ä¸Šä¼ äº§ç‰©ï¼ˆå«æ—¥å¿—ï¼‰
        uses: actions/upload-artifact@v4
        with:
          name: HMA++-Next-KPM-${{ github.event.inputs.build_mode }}-${KERNEL_VER}
          path: |
            HMA++.c
            HMA++.o
            HMA_Next.ko
            HMA++.kpm
            Makefile
            ./*.log
          retention-days: 90
          if-no-files-found: error

      - name: ğŸ“ æ„å»ºæŠ¥å‘Š
        run: |
          KERNEL_DISPLAY=$(if [ -n "${{ github.event.inputs.kernel_version }}" ]; then echo "${{ github.event.inputs.kernel_version }}"; else echo "é»˜è®¤ï¼ˆ$(uname -r)ï¼‰"; fi)
          echo "========================================"
          echo "âœ… HMA++ Next KPM æ¨¡å—æ„å»ºæˆåŠŸï¼"
          echo "ğŸ“Œ æºç æ–‡ä»¶ï¼šHMA++.c"
          echo "ğŸ“Œ æ„å»ºæ¨¡å¼ï¼š${{ github.event.inputs.build_mode }}"
          echo "ğŸ“Œ å†…æ ¸ç‰ˆæœ¬ï¼š${KERNEL_DISPLAY}"
          echo "ğŸ“Œ KPM ç‰ˆæœ¬ï¼š${KPM_INSTALLED_VER}"
          echo "ğŸ“Œ æœ€ç»ˆäº§ç‰©ï¼šHMA++.kpmï¼ˆå¤§å°ï¼š$(du -sh HMA++.kpm | awk '{print $1}')ï¼‰"
          echo "========================================"
