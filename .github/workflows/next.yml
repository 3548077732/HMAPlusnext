name: HMA++ KPM Build (KernelPatch Toolchain)
on:
  workflow_dispatch:
    inputs:
      kernel_arch:
        description: "è®¾å¤‡æ¶æ„ï¼ˆarm64/armï¼‰"
        required: true
        default: "arm64"
        type: choice
        options:
          - arm64
          - arm

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout HMA++ æºç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: å®‰è£…åŸºç¡€ä¾èµ–
        run: |
          sudo apt update -y
          sudo apt install -y git wget unzip build-essential clang llvm lld binutils
          sudo apt clean
          chmod -R 777 $(pwd)

      - name: å…‹éš† KernelPatch æ„å»ºå·¥å…·
        run: |
          # å…‹éš†å®˜æ–¹ KPM æ„å»ºå·¥å…·
          git clone --depth 1 https://github.com/bmax121/KernelPatch.git ./KernelPatch
          chmod -R 777 ./KernelPatch
          echo "âœ… KernelPatch å·¥å…·å…‹éš†æˆåŠŸï¼"

      - name: é…ç½® KPM æ„å»ºç¯å¢ƒï¼ˆè‡ªåŠ¨å¤„ç†å†…æ ¸ä¾èµ–ï¼‰
        run: |
          # è¿›å…¥å·¥å…·ç›®å½•ï¼Œé…ç½®ç¯å¢ƒ
          cd ./KernelPatch
          # ä¸‹è½½å¯¹åº”æ¶æ„çš„ NDK å·¥å…·é“¾ï¼ˆå·¥å…·è‡ªåŠ¨é€‚é…ï¼‰
          ./tools/download_ndk.sh ${{ github.event.inputs.kernel_arch }}
          # ç”Ÿæˆ KPM æ„å»ºé…ç½®ï¼ˆè‡ªåŠ¨å…³è”å†…æ ¸å¤´æ–‡ä»¶å’Œå·¥å…·é“¾ï¼‰
          ./tools/gen_kpm_config.sh ${{ github.event.inputs.kernel_arch }} ../
          cd ..
          echo "âœ… KPM æ„å»ºç¯å¢ƒé…ç½®å®Œæˆï¼"

      - name: è¡¥å…… HMA++ æ¨¡å—é…ç½®ï¼ˆé€‚é… KernelPatchï¼‰
        run: |
          # åˆ›å»º KernelPatch å…¼å®¹çš„ Makefileï¼ˆå·¥å…·è‡ªåŠ¨è¯†åˆ«ï¼‰
          cat > ./Makefile << EOF
          # KernelPatch KPM æ„å»ºè§„åˆ™ï¼ˆæ— éœ€æ‰‹åŠ¨é…ç½®å†…æ ¸è·¯å¾„ï¼‰
          include ./KernelPatch/kpm.mk
          
          # æ¨¡å—ä¿¡æ¯
          MODULE_NAME := HMA++
          MODULE_AUTHOR := NightFallsLikeRain
          MODULE_DESCRIPTION := "HMA++ Next: åŸºäºç™½åå•çš„åº”ç”¨æ–‡ä»¶æ“ä½œæ‹¦æˆª KPM æ¨¡å—"
          MODULE_LICENSE := GPL-3.0
          
          # æºç æ–‡ä»¶
          SRC_FILES := HMA++.c
          
          # ç¼–è¯‘é€‰é¡¹ï¼ˆå·¥å…·è‡ªåŠ¨æ³¨å…¥å†…æ ¸å¤´æ–‡ä»¶è·¯å¾„ï¼‰
          EXTRA_CFLAGS += -Wall -O2 -fPIC -w -DKERNEL_5_15 -fno-pie
          EOF
          
          # ç¡®ä¿ HMA++.c å­˜åœ¨ï¼ˆç”¨æˆ·éœ€è‡ªè¡Œä¿è¯æºç åœ¨æ ¹ç›®å½•ï¼‰
          [ ! -f "./HMA++.c" ] && { echo "âŒ æœªæ‰¾åˆ° HMA++.c æºç æ–‡ä»¶ï¼"; exit 1; }
          chmod 777 ./Makefile ./HMA++.c
          echo "âœ… æ¨¡å—é…ç½®å®Œæˆï¼"

      - name: ç¼–è¯‘ HMA++ KPM æ¨¡å—ï¼ˆKernelPatch è‡ªåŠ¨æ„å»ºï¼‰
        run: |
          # ç›´æ¥è°ƒç”¨ makeï¼ŒKernelPatch è‡ªåŠ¨å¤„ç†æ‰€æœ‰ä¾èµ–
          make -j2 V=1 || { echo "âŒ æ¨¡å—ç¼–è¯‘å¤±è´¥ï¼"; exit 1; }
          
          # éªŒè¯æ¨¡å—ç”Ÿæˆ
          if [ -f "./HMA++.ko" ]; then
            echo "ğŸ‰ HMA++ KPM æ¨¡å—ç¼–è¯‘æˆåŠŸï¼"
            ls -la ./HMA++.ko
            file ./HMA++.ko
          else
            echo "âŒ æ¨¡å—æ–‡ä»¶æœªç”Ÿæˆï¼"
            exit 1
          fi
          chmod 777 ./HMA++.ko

      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: HMA++-Next-KPM-${{ github.event.inputs.kernel_arch }}
          path: |
            HMA++.ko
            Makefile
          retention-days: 90
        if: success()
