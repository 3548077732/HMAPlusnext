name: HMA++ KPM Build (KernelPatch Official)
on:
  workflow_dispatch:
    inputs:
      kernel_arch:
        description: "è®¾å¤‡æž¶æž„ï¼ˆarm64/armï¼‰"
        required: true
        default: "arm64"
        type: choice
        options:
          - arm64
          - arm

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout HMA++ æºç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: å®‰è£…åŸºç¡€ä¾èµ–
        run: |
          sudo apt update -y
          sudo apt install -y git wget unzip build-essential clang llvm lld binutils
          sudo apt clean
          chmod -R 777 $(pwd)

      - name: å…‹éš† KernelPatch å®˜æ–¹å·¥å…·
        run: |
          git clone --depth 1 https://github.com/bmax121/KernelPatch.git ./KernelPatch
          # éªŒè¯æ ¸å¿ƒæž„å»ºæ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼ˆkpm.mk æ˜¯å…³é”®ï¼‰
          [ ! -f "./KernelPatch/kpm/kpm.mk" ] && { echo "âŒ KernelPatch æ ¸å¿ƒæ–‡ä»¶ç¼ºå¤±ï¼"; exit 1; }
          chmod -R 777 ./KernelPatch
          echo "âœ… KernelPatch å·¥å…·å…‹éš†æˆåŠŸï¼"

      - name: æ‰‹åŠ¨ä¸‹è½½ Android NDK r25cï¼ˆå·¥å…·ä¾èµ–ï¼Œæ— è‡ªåŠ¨ä¸‹è½½è„šæœ¬ï¼‰
        run: |
          mkdir -p ./ndk
          # ä¸‹è½½å…¼å®¹çš„ NDK ç‰ˆæœ¬ï¼ˆKernelPatch æŽ¨è r25cï¼‰
          wget -q https://dl.google.com/android/repository/android-ndk-r25c-linux.zip -O ndk.zip
          unzip -q -o ndk.zip -d ./ndk
          NDK_ROOT=$(pwd)/ndk/android-ndk-r25c
          # éªŒè¯ NDK å·¥å…·é“¾å­˜åœ¨
          [ ! -d "$NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64" ] && { echo "âŒ NDK ä¸‹è½½å¤±è´¥ï¼"; exit 1; }
          echo "NDK_ROOT=$NDK_ROOT" >> $GITHUB_ENV
          chmod -R 777 ./ndk
          echo "âœ… NDK å‡†å¤‡æˆåŠŸï¼è·¯å¾„ï¼š$NDK_ROOT"

      - name: é…ç½® KernelPatch æž„å»ºçŽ¯å¢ƒï¼ˆé€‚é…å®˜æ–¹è§„åˆ™ï¼‰
        run: |
          # 1. å¤åˆ¶ KernelPatch æ ¸å¿ƒæž„å»ºæ–‡ä»¶åˆ°é¡¹ç›®æ ¹ç›®å½•ï¼ˆå·¥å…·è¦æ±‚ï¼‰
          cp -r ./KernelPatch/kpm ./kpm
          # 2. ç”Ÿæˆå·¥å…·é…ç½®æ–‡ä»¶ï¼ˆæŒ‡å®š NDK è·¯å¾„ï¼Œé€‚é…æž¶æž„ï¼‰
          ARCH=${{ github.event.inputs.kernel_arch }}
          cat > ./kpm_config.mk << EOF
          # KernelPatch é…ç½®æ–‡ä»¶ï¼ˆå®˜æ–¹è§„èŒƒï¼‰
          NDK_ROOT := ${{ env.NDK_ROOT }}
          ARCH := $ARCH
          # è‡ªåŠ¨åŒ¹é…ç¼–è¯‘å™¨ï¼ˆarm64=aarch64ï¼Œarm=armv7aï¼‰
          ifeq (\$(ARCH), arm64)
            TARGET := aarch64-linux-android
            CC := \$(NDK_ROOT)/toolchains/llvm/prebuilt/linux-x86_64/bin/\$(TARGET)24-clang
          else
            TARGET := armv7a-linux-androideabi
            CC := \$(NDK_ROOT)/toolchains/llvm/prebuilt/linux-x86_64/bin/\$(TARGET)24-clang
          endif
          LD := \$(NDK_ROOT)/toolchains/llvm/prebuilt/linux-x86_64/bin/ld.lld
          OBJCOPY := \$(NDK_ROOT)/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-objcopy
          NM := \$(NDK_ROOT)/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-nm
          EXTRA_CFLAGS := -Wall -O2 -fPIC -w -DKERNEL_5_15 -fno-pie -nostdinc
          EOF
          chmod 777 ./kpm_config.mk ./kpm
          echo "âœ… KernelPatch çŽ¯å¢ƒé…ç½®å®Œæˆï¼"

      - name: ç¼–å†™å…¼å®¹ KernelPatch çš„ Makefile
        run: |
          # ä¸¥æ ¼éµå¾ª KernelPatch å®˜æ–¹æž„å»ºè§„åˆ™
          cat > ./Makefile << EOF
          # åŒ…å« KernelPatch æ ¸å¿ƒæž„å»ºé€»è¾‘ï¼ˆå®˜æ–¹è·¯å¾„ï¼‰
          include ./kpm/kpm.mk
          
          # æ¨¡å—ä¿¡æ¯ï¼ˆå·¥å…·è¦æ±‚çš„å¿…å¡«é¡¹ï¼‰
          MODULE_NAME := HMA++
          MODULE_AUTHOR := NightFallsLikeRain
          MODULE_DESCRIPTION := "HMA++ Next: åŸºäºŽç™½åå•çš„åº”ç”¨æ–‡ä»¶æ“ä½œæ‹¦æˆª KPM æ¨¡å—"
          MODULE_LICENSE := GPL-2.0
          MODULE_VERSION := 1.0.0
          
          # æºç æ–‡ä»¶ï¼ˆé¡¹ç›®æ ¸å¿ƒæºç ï¼‰
          SRC_FILES := HMA++.c
          
          # é™„åŠ ç¼–è¯‘é€‰é¡¹ï¼ˆç»§æ‰¿ kpm_config.mk é…ç½®ï¼‰
          EXTRA_CFLAGS += \$(shell cat ./kpm_config.mk | grep EXTRA_CFLAGS | cut -d '=' -f 2-)
          EOF
          
          # éªŒè¯æºç æ–‡ä»¶å­˜åœ¨
          [ ! -f "./HMA++.c" ] && { echo "âŒ è¯·å°† HMA++.c æºç æ”¾åœ¨é¡¹ç›®æ ¹ç›®å½•ï¼"; exit 1; }
          chmod 777 ./Makefile ./HMA++.c
          echo "âœ… Makefile é…ç½®å®Œæˆï¼"

      - name: ç¼–è¯‘ HMA++ KPM æ¨¡å—ï¼ˆKernelPatch å®˜æ–¹æµç¨‹ï¼‰
        run: |
          # ç›´æŽ¥è°ƒç”¨ makeï¼Œå·¥å…·è‡ªåŠ¨å¤„ç†å†…æ ¸ä¾èµ–ã€å¤´æ–‡ä»¶ã€å·¥å…·é“¾
          make -j2 V=1 || { echo "âŒ æ¨¡å—ç¼–è¯‘å¤±è´¥ï¼"; exit 1; }
          
          # éªŒè¯æ¨¡å—ç”Ÿæˆ
          if [ -f "./\$(MODULE_NAME).ko" ]; then
            mv ./\$(MODULE_NAME).ko ./HMA++.ko  # ç»Ÿä¸€æ¨¡å—åç§°
            echo "ðŸŽ‰ HMA++ KPM æ¨¡å—ç¼–è¯‘æˆåŠŸï¼"
            ls -la ./HMA++.ko
            file ./HMA++.ko
          else
            echo "âŒ æ¨¡å—æ–‡ä»¶æœªç”Ÿæˆï¼"
            exit 1
          fi
          chmod 777 ./HMA++.ko

      - name: ä¸Šä¼ æž„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: HMA++-Next-KPM-${{ github.event.inputs.kernel_arch }}
          path: |
            HMA++.ko
            Makefile
            kpm_config.mk
          retention-days: 90
        if: success()
