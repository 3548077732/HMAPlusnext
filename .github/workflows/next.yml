name: Build

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout HMA++ æºç 
        uses: actions/checkout@v5

      - name: å®‰è£…å®Œæ•´ç¼–è¯‘ä¾èµ–
        run: |
          sudo apt update -y && sudo apt install -y \
            build-essential clang llvm lld binutils \
            wget unzip libssl-dev libelf-dev git
          sudo apt clean
          echo "âœ… ä¾èµ–å®‰è£…å®Œæˆï¼"

      - name: ä¸‹è½½å¹¶è§£å‹ NDK r25cï¼ˆéªŒè¯ç›®å½•ç»“æ„ï¼‰
        run: |
          echo "ğŸ“¥ ä¸‹è½½ NDK r25c..."
          wget -q https://dl.google.com/android/repository/android-ndk-r25c-linux.zip -O ndk.zip
          unzip -q -o ndk.zip
          NDK_ROOT=$(pwd)/android-ndk-r25c
          
          # å…³é”®éªŒè¯ï¼šå·¥å…·é“¾å’Œ sysroot æ˜¯å¦å­˜åœ¨
          TOOLCHAIN=$NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64
          SYSROOT=$TOOLCHAIN/sysroot
          if [ ! -d "$TOOLCHAIN" ]; then
            echo "âŒ NDK å·¥å…·é“¾ç¼ºå¤±ï¼è·¯å¾„ï¼š$TOOLCHAIN"
            ls -la $NDK_ROOT/toolchains/llvm/prebuilt/
            exit 1
          fi
          if [ ! -d "$SYSROOT" ]; then
            echo "âŒ sysroot è·¯å¾„ä¸å­˜åœ¨ï¼æ­£ç¡®è·¯å¾„ï¼š$SYSROOT"
            ls -la $TOOLCHAIN/
            exit 1
          fi
          
          # é…ç½®ç¯å¢ƒå˜é‡ï¼ˆä¼ é€’ç»™ Makefileï¼‰
          echo "NDK_ROOT=$NDK_ROOT" >> $GITHUB_ENV
          echo "TOOLCHAIN=$TOOLCHAIN" >> $GITHUB_ENV
          chmod -R 777 $NDK_ROOT
          echo "âœ… NDK å‡†å¤‡æˆåŠŸï¼sysrootï¼š$SYSROOT"

      - name: å…‹éš† Android 5.15 å†…æ ¸å¤´æ–‡ä»¶ï¼ˆå« KPM å¤´æ–‡ä»¶ï¼‰
        run: |
          echo "ğŸ“¥ å…‹éš†å†…æ ¸å¤´æ–‡ä»¶..."
          git clone --depth 1 -b android13-5.15 https://android.googlesource.com/kernel/common.git kernel-src
          mkdir -p ./kernel-headers
          
          # å¤åˆ¶æ ¸å¿ƒå†…æ ¸å¤´æ–‡ä»¶
          cp -r kernel-src/include/linux ./kernel-headers/
          cp -r kernel-src/include/asm-generic ./kernel-headers/
          cp -r kernel-src/include/uapi ./kernel-headers/
          cp -r kernel-src/arch/arm64/include ./kernel-headers/arch-arm64
          cp -r kernel-src/arch/arm64/include/asm ./kernel-headers/arch-arm64/asm
          
          # å¤åˆ¶ KPM å¤´æ–‡ä»¶ï¼ˆé€‚é… 5.15+ å†…æ ¸ KPM æ¡†æ¶ï¼‰
          mkdir -p ./kernel-headers/kpm
          wget -q -O ./kernel-headers/kpm/kpm.h "https://raw.githubusercontent.com/bmax121/KernelPatch/main/kpm/kpm.h"
          
          # éªŒè¯å…³é”®å¤´æ–‡ä»¶
          [ ! -f "./kernel-headers/kpm/kpm.h" ] && { echo "âŒ KPM å¤´æ–‡ä»¶ç¼ºå¤±ï¼"; exit 1; }
          [ ! -f "./kernel-headers/arch-arm64/asm/cache.h" ] && { echo "âŒ asm/cache.h ç¼ºå¤±ï¼"; exit 1; }
          
          chmod -R 777 ./kernel-headers
          echo "âœ… å†…æ ¸å¤´æ–‡ä»¶å‡†å¤‡æˆåŠŸï¼"

      - name: ç”Ÿæˆä¿®æ­£åçš„ Makefile
        run: |
          # å†™å…¥ä¸Šé¢çš„ä¿®æ­£ç‰ˆ Makefile
          cat > ./Makefile << EOF
          # çº¯æ‰‹åŠ¨ç¼–è¯‘ Makefileï¼ˆä¿®å¤ NDK sysroot è·¯å¾„ï¼Œé€‚é… Android 13-5.15+ï¼‰
          MODULE_NAME := HMA++
          OBJ_NAME := \$(MODULE_NAME).o
          KO_NAME := \$(MODULE_NAME).ko
          KPM_NAME := \$(MODULE_NAME).kpm

          # å·¥å…·é“¾é…ç½®ï¼ˆä» GitHub Actions ç¯å¢ƒå˜é‡è¯»å–ï¼Œè·¯å¾„ä¿®æ­£ï¼‰
          NDK_ROOT ?= ./android-ndk-r25c
          TOOLCHAIN := \$(NDK_ROOT)/toolchains/llvm/prebuilt/linux-x86_64
          CC := \$(TOOLCHAIN)/bin/aarch64-linux-android24-clang
          LD := \$(TOOLCHAIN)/bin/ld.lld
          # å…³é”®ä¿®æ­£ï¼šsysroot åœ¨å·¥å…·é“¾ç›®å½•ä¸‹ï¼Œè€Œé NDK æ ¹ç›®å½•
          KERNELDIR := \$(TOOLCHAIN)/sysroot

          # å¤´æ–‡ä»¶è·¯å¾„ï¼ˆåŸºäºä¿®æ­£åçš„ sysrootï¼Œè¦†ç›–æ‰€æœ‰ä¾èµ–ï¼‰
          INCLUDES := -I./kernel-headers \
                      -I./kernel-headers/arch-arm64 \
                      -I./kernel-headers/arch-arm64/asm \
                      -I./kernel-headers/linux \
                      -I./kernel-headers/asm-generic \
                      -I./kernel-headers/uapi \
                      -I\$(KERNELDIR)/usr/include \
                      -I\$(KERNELDIR)/usr/include/aarch64-linux-android \
                      -I\$(NDK_ROOT)/sysroot/usr/include \
                      -I\$(NDK_ROOT)/sysroot/usr/include/aarch64-linux-android

          # ç¼–è¯‘é€‰é¡¹ï¼ˆé€‚é… 5.15+ å†…æ ¸ + LLVMï¼Œæ·»åŠ  KPM å¤´æ–‡ä»¶è·¯å¾„ï¼‰
          EXTRA_CFLAGS := \$(INCLUDES) \
                          -target aarch64-linux-android \
                          -DKERNEL_5_15 \
                          -D__KERNEL__ \
                          -DMODULE \
                          -Wall -O2 -fPIC -w \
                          -fno-pie -fno-asynchronous-unwind-tables \
                          -mgeneral-regs-only -march=armv8-a \
                          -nostdinc -fno-common \
                          -Wno-implicit-function-declaration \
                          -Wno-incompatible-pointer-types \
                          -I./kernel-headers/kpm  # é€‚é… KPM å¤´æ–‡ä»¶

          # æ¨¡å—ç¼–è¯‘è§„åˆ™ï¼ˆæ— ç¼©è¿›ï¼Œè¯­æ³•é›¶é”™è¯¯ï¼‰
          obj-m += \$(OBJ_NAME)
          \$(OBJ_NAME): \$(MODULE_NAME).c; \$(MAKE) -C \$(KERNELDIR) M=\$(PWD) ARCH=arm64 CC=\$(CC) LD=\$(LD) EXTRA_CFLAGS="\$(EXTRA_CFLAGS)" modules

          # æ„å»ºç›®æ ‡ï¼ˆäº§ç‰©é‡å‘½åï¼‰
          all: \$(KO_NAME); mv \$(KO_NAME) \$(KPM_NAME); echo "âœ… ç¼–è¯‘å®Œæˆï¼äº§ç‰©ï¼š\$(KPM_NAME)"

          # æ¸…ç†ç›®æ ‡
          clean:; \$(MAKE) -C \$(KERNELDIR) M=\$(PWD) clean; rm -rf \$(KPM_NAME) *.mod.c *.o .*.cmd Module.symvers modules.order .tmp_versions; echo "âœ… æ¸…ç†å®Œæˆï¼"

          .PHONY: all clean
          EOF
          
          # éªŒè¯æºç æ–‡ä»¶
          [ ! -f "./HMA++.c" ] && { echo "âŒ æœªæ‰¾åˆ° HMA++.c æºç æ–‡ä»¶ï¼"; exit 1; }
          chmod 777 ./Makefile ./HMA++.c
          echo "âœ… Makefile ç”Ÿæˆå®Œæˆï¼"

      - name: ç¼–è¯‘ HMA++ æ¨¡å—ï¼ˆè¯¦ç»†æ—¥å¿—ï¼‰
        run: |
          echo "ğŸ”¨ å¼€å§‹ç¼–è¯‘æ¨¡å—...ï¼ˆsysrootï¼š$TOOLCHAIN/sysrootï¼‰"
          make V=1 || { echo "âŒ ç¼–è¯‘å¤±è´¥ï¼"; exit 1; }

      - name: éªŒè¯äº§ç‰©å¹¶ä¸Šä¼ 
        run: |
          if [ ! -f "./HMA++.kpm" ]; then
            echo "âŒ ç›®æ ‡äº§ç‰© HMA++.kpm æœªç”Ÿæˆï¼"
            ls -la ./
            exit 1
          fi
          echo "âœ… äº§ç‰©éªŒè¯æˆåŠŸï¼"
        uses: actions/upload-artifact@v4
        with:
          name: HMA++.kpm
          path: HMA++.kpm
          retention-days: 90
