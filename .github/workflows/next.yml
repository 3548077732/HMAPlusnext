name: Apatch KPM Build (Kernel 5.15+)
on:
  workflow_dispatch:
    inputs:
      kernel_arch:
        description: "设备架构（arm64/arm）"
        required: true
        default: "arm64"
        type: choice
        options:
          - arm64
          - arm

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1  # 优化拉取速度

      - name: Install Dependencies
        run: |
          sudo apt update -y
          sudo apt install -y build-essential git wget gcc-aarch64-linux-gnu gcc-arm-linux-gnueabihf
          sudo apt clean  # 清理缓存

      - name: Download Kernel 5.15+ Headers
        run: |
          mkdir -p ./kernel-headers
          if [ "${{ github.event.inputs.kernel_arch }}" = "arm64" ]; then
            wget https://github.com/apatch-project/apatch-kernel-headers/raw/main/headers-5.15-arm64.tar.gz -O kernel-headers.tar.gz || exit 1
          else
            wget https://github.com/apatch-project/apatch-kernel-headers/raw/main/headers-5.15-arm.tar.gz -O kernel-headers.tar.gz || exit 1
          fi
          tar -zxvf kernel-headers.tar.gz -C ./kernel-headers || exit 1

      - name: Build HMA++ KPM Module
        run: |
          export KERNELDIR=$(pwd)/kernel-headers
          export ARCH=${{ github.event.inputs.kernel_arch }}
          if [ "$ARCH" = "arm64" ]; then
            export CROSS_COMPILE=aarch64-linux-gnu-
          else
            export CROSS_COMPILE=arm-linux-gnueabihf-
          fi
          make clean
          make -j$(nproc) || exit 1

      - name: Upload Build Output
        uses: actions/upload-artifact@v4
        with:
          name: HMA++-Next-KPM-${{ github.event.inputs.kernel_arch }}
          path: |
            HMA++.ko
            Makefile
          retention-days: 90
        if: success()  # 仅编译成功时上传
