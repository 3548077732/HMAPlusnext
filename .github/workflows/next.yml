name: Build

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout HMA++ 源码
        uses: actions/checkout@v5

      - name: Checkout KernelPatch
        uses: actions/checkout@v5
        with:
          repository: bmax121/KernelPatch
          path: /home/runner/work/HMAPlusPlus/HMAPlusPlus/KernelPatch

      - name: 验证 KernelPatch 目录结构
        run: |
          ls -R /home/runner/work/HMAPlusPlus/HMAPlusPlus/KernelPatch
          # 确保核心 kpm.mk 存在，不存在则直接下载备用
          KPM_MK_PATH="/home/runner/work/HMAPlusPlus/HMAPlusPlus/KernelPatch/kpm/kpm.mk"
          if [ ! -f "$KPM_MK_PATH" ]; then
            echo "⚠️  未找到 kpm.mk，下载备用版本"
            mkdir -p /home/runner/work/HMAPlusPlus/HMAPlusPlus/KernelPatch/kpm
            wget -q -O $KPM_MK_PATH "https://raw.githubusercontent.com/bmax121/KernelPatch/main/kpm/kpm.mk"
          fi
          chmod -R 777 /home/runner/work/HMAPlusPlus/HMAPlusPlus/KernelPatch

      - name: 安装完整依赖
        run: |
          sudo apt update -y
          sudo apt install -y build-essential wget unzip clang llvm lld binutils
          sudo apt clean

      - name: 下载并解压 Android NDK r25c（兼容 KernelPatch）
        run: |
          # 下载 NDK（稳定兼容，避免速度限制）
          wget -q https://dl.google.com/android/repository/android-ndk-r25c-linux.zip -O ndk.zip
          unzip -q -o ndk.zip
          # 验证 NDK 工具链
          NDK_ROOT=$(pwd)/android-ndk-r25c
          if [ ! -d "$NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64" ]; then
            echo "❌ NDK 解压失败！"
            exit 1
          fi
          echo "NDK_ROOT=$NDK_ROOT" >> $GITHUB_ENV
          chmod -R 777 $NDK_ROOT

      - name: 配置 KernelPatch 构建环境
        run: |
          # 复制核心构建文件到项目根目录
          cp -r /home/runner/work/HMAPlusPlus/HMAPlusPlus/KernelPatch/kpm ./kpm
          # 编写配置文件（适配 arm64 架构，可根据需求修改）
          ARCH="arm64"
          TARGET="aarch64-linux-android"
          cat > ./kpm_config.mk << EOF
          NDK_ROOT := ${{ env.NDK_ROOT }}
          ARCH := $ARCH
          TARGET := $TARGET
          CC := \$(NDK_ROOT)/toolchains/llvm/prebuilt/linux-x86_64/bin/\$(TARGET)24-clang
          LD := \$(NDK_ROOT)/toolchains/llvm/prebuilt/linux-x86_64/bin/ld.lld
          OBJCOPY := \$(NDK_ROOT)/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-objcopy
          NM := \$(NDK_ROOT)/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-nm
          EXTRA_CFLAGS := -target \$(TARGET) -Wall -O2 -fPIC -w -DKERNEL_5_15 -fno-pie -nostdinc -I\$(NDK_ROOT)/sysroot/usr/include -I\$(NDK_ROOT)/sysroot/usr/include/\$(TARGET)
          EOF
          chmod 777 ./kpm ./kpm_config.mk

      - name: 编写适配 Makefile
        run: |
          cat > ./Makefile << EOF
          include ./kpm/kpm.mk
          include ./kpm_config.mk

          # 模块信息
          MODULE_NAME := HMA++
          MODULE_AUTHOR := NightFallsLikeRain
          MODULE_DESCRIPTION := "HMA++ Next: 基于白名单的应用文件操作拦截 KPM 模块"
          MODULE_LICENSE := GPL-2.0
          MODULE_VERSION := 1.0.0

          # 源码文件（确保 HMA++.c 在项目根目录）
          SRC_FILES := HMA++.c

          # 构建目标（按用户模板输出 HMA++.kpm）
          all: \$(MODULE_NAME).ko
              mv \$(MODULE_NAME).ko \$(MODULE_NAME).kpm

          clean:
              rm -f \$(MODULE_NAME).ko \$(MODULE_NAME).kpm *.mod.c *.o .*.cmd Module.symvers modules.order
          EOF
          # 验证源码文件存在
          if [ ! -f "./HMA++.c" ]; then
            echo "❌ 未找到 HMA++.c 源码文件！"
            exit 1
          fi
          chmod 777 ./Makefile ./HMA++.c

      - name: 编译 HMA++ 模块
        run: make -j2 V=1 || { echo "❌ 编译失败！"; exit 1; }

      - name: 上传产物（按用户模板命名 HMA++.kpm）
        uses: actions/upload-artifact@v4
        with:
          name: HMA++.kpm
          path: HMA++.kpm
          retention-days: 90
