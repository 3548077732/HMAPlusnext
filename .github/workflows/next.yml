# .github/workflows/build-hma-kpm.yml
name: æ‰‹åŠ¨æž„å»º HMA++ Next KPM æ¨¡å—
on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘æ ¸å¿ƒ
    inputs:
      kernel_version:
        description: "æŒ‡å®šå†…æ ¸ç‰ˆæœ¬ï¼ˆå¦‚ 5.15.0-78-genericï¼Œç•™ç©ºç”¨é»˜è®¤ï¼‰"
        required: false
        default: ""
      build_mode:
        description: "æž„å»ºæ¨¡å¼"
        type: choice
        required: true
        default: "release"
        options:
          - release  # å‘å¸ƒæ¨¡å¼ï¼ˆç²¾ç®€ä½“ç§¯ï¼Œæ— è°ƒè¯•ä¿¡æ¯ï¼‰
          - debug    # è°ƒè¯•æ¨¡å¼ï¼ˆä¿ç•™è°ƒè¯•ä¿¡æ¯ï¼Œä¾¿äºŽæŽ’æŸ¥ï¼‰

jobs:
  build-kpm:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # ç”¨äºŽä¸Šä¼ KPMäº§ç‰©

    steps:
      - name: ðŸ” æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 1  # ä»…æ‹‰å–æœ€æ–°ä»£ç ï¼ŒåŠ é€Ÿæž„å»º

      - name: ðŸ› ï¸ å®‰è£…ç¼–è¯‘ä¾èµ–ï¼ˆå« KPM å·¥å…·é“¾ï¼‰
        run: |
          sudo apt update -y
          # åŸºç¡€ç¼–è¯‘å·¥å…·
          sudo apt install -y gcc make linux-headers-$(uname -r) libelf-dev bc flex bison dwarves
          # å®‰è£… KPM æ¡†æž¶å·¥å…·é“¾ï¼ˆæ‰“åŒ… .kpm å¿…éœ€ï¼‰
          git clone https://github.com/chenxyu/kpm.git /tmp/kpm
          cd /tmp/kpm
          make -j$(nproc)
          sudo make install
          # éªŒè¯ KPM å®‰è£…
          if ! command -v kpm &> /dev/null; then
            echo "é”™è¯¯ï¼šKPM å·¥å…·å®‰è£…å¤±è´¥ï¼"
            exit 1
          fi
          # å®‰è£…æŒ‡å®šå†…æ ¸å¤´æ–‡ä»¶ï¼ˆå¯é€‰ï¼‰
          if [ -n "${{ github.event.inputs.kernel_version }}" ]; then
            sudo apt install -y linux-headers-${{ github.event.inputs.kernel_version }}
          fi

      - name: âš™ï¸ é…ç½®æž„å»ºå‚æ•°
        run: |
          # è°ƒè¯•æ¨¡å¼æ·»åŠ  -g ç¼–è¯‘é€‰é¡¹
          if [ "${{ github.event.inputs.build_mode }}" = "debug" ]; then
            echo "EXTRA_CFLAGS=-g" >> $GITHUB_ENV
          fi
          # æŒ‡å®š KPM æ¨¡å—å…ƒä¿¡æ¯ï¼ˆä¸Žä»£ç ä¸­ä¸€è‡´ï¼‰
          echo "KPM_NAME=HMA++ Next" >> $GITHUB_ENV
          echo "KPM_VERSION=1.0.12" >> $GITHUB_ENV

      - name: ðŸš€ ç¼–è¯‘å†…æ ¸æ¨¡å—ï¼ˆ.koï¼‰
        run: |
          make clean
          # å¤šçº¿ç¨‹ç¼–è¯‘ï¼Œé€‚é… KPM æ¡†æž¶ç¼–è¯‘è§„åˆ™
          make -j$(nproc) EXTRA_CFLAGS="${{ env.EXTRA_CFLAGS }}"
          # éªŒè¯ .ko æ–‡ä»¶ç”Ÿæˆ
          if [ ! -f "HMA++.ko" ]; then
            echo "é”™è¯¯ï¼šå†…æ ¸æ¨¡å—ç¼–è¯‘å¤±è´¥ï¼"
            exit 1
          fi
          modinfo HMA++.ko  # è¾“å‡ºæ¨¡å—ä¿¡æ¯ï¼ŒéªŒè¯åˆæ³•æ€§

      - name: ðŸ“¦ æ‰“åŒ…ä¸º KPM æ¨¡å—ï¼ˆæ ¸å¿ƒæ­¥éª¤ï¼‰
        run: |
          # ä½¿ç”¨ KPM å·¥å…·æ‰“åŒ… .ko ä¸º .kpmï¼ˆç¬¦åˆ KPM åŠ è½½è§„èŒƒï¼‰
          kpm pack \
            --name "${{ env.KPM_NAME }}" \
            --version "${{ env.KPM_VERSION }}" \
            --author "NightFallsLikeRain" \
            --license "GPLv3" \
            --description "å…¨åº”ç”¨é£Žé™©+å¹¿å‘Šæ‹¦æˆªï¼ˆå«å¾®ä¿¡/QQ/é“¶è¡Œ/ç³»ç»Ÿè½¯ä»¶ç™½åå•ï¼‰" \
            --input "HMA++.ko" \
            --output "HMA++_Next_${{ github.event.inputs.build_mode }}.kpm"
          # éªŒè¯ KPM æ–‡ä»¶ç”Ÿæˆ
          if [ ! -f "HMA++_Next_${{ github.event.inputs.build_mode }}.kpm" ]; then
            echo "é”™è¯¯ï¼šKPM æ¨¡å—æ‰“åŒ…å¤±è´¥ï¼"
            exit 1
          fi
          # è¾“å‡º KPM æ¨¡å—ä¿¡æ¯
          kpm info "HMA++_Next_${{ github.event.inputs.build_mode }}.kpm"

      - name: ðŸ“¤ ä¸Šä¼  KPM äº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: HMA++-Next-KPM-${{ github.event.inputs.build_mode }}
          path: |
            HMA++_Next_${{ github.event.inputs.build_mode }}.kpm  # æ ¸å¿ƒKPMäº§ç‰©
            HMA++.ko  # ä¿ç•™åŽŸå§‹.koï¼Œä¾¿äºŽå¤‡ç”¨
            Makefile  # æž„å»ºé…ç½®æ–‡ä»¶
          retention-days: 90  # äº§ç‰©ä¿ç•™90å¤©ï¼Œæ»¡è¶³é•¿æœŸä½¿ç”¨éœ€æ±‚
          if-no-files-found: error  # æ— äº§ç‰©æ—¶æ ‡è®°æž„å»ºå¤±è´¥

      - name: ðŸ“ æž„å»ºæŠ¥å‘Šï¼ˆå«ä½¿ç”¨è¯´æ˜Žï¼‰
        run: |
          echo "========================================"
          echo "âœ… KPM æ¨¡å—æž„å»ºå®Œæˆï¼"
          echo "ðŸ“Œ æž„å»ºæ¨¡å¼ï¼š${{ github.event.inputs.build_mode }}"
          echo "ðŸ“Œ å†…æ ¸ç‰ˆæœ¬ï¼š${{ github.event.inputs.kernel_version || 'é»˜è®¤ï¼ˆ'$(uname -r)')' }}"
          echo "ðŸ“Œ äº§ç‰©åç§°ï¼šHMA++_Next_${{ github.event.inputs.build_mode }}.kpm"
          echo "ðŸ“Œ åŠ è½½å‘½ä»¤ï¼škpm load HMA++_Next_${{ github.event.inputs.build_mode }}.kpm"
          echo "ðŸ“Œ æŽ§åˆ¶å‘½ä»¤ï¼šecho '1,1' > /proc/kpmctl/HMA++ Next"
          echo "ðŸ“Œ æ—¥å¿—æŸ¥çœ‹ï¼šdmesg | grep [HMA++]"
          echo "========================================"
