name: Build2

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout HMA++ æºç 
        uses: actions/checkout@v5

      - name: å®‰è£…å®Œæ•´ç¼–è¯‘ä¾èµ–
        run: |
          sudo apt update -y
          sudo apt install -y build-essential wget unzip clang llvm lld binutils libssl-dev libelf-dev
          sudo apt clean
          chmod -R 777 $(pwd)

      - name: ä¸‹è½½å¹¶è§£å‹ Android NDK r25cï¼ˆç¨³å®šå…¼å®¹ 5.15 å†…æ ¸ï¼‰
        run: |
          # ä¸‹è½½ NDKï¼ˆé¿å…é€Ÿåº¦é™åˆ¶ï¼Œä½¿ç”¨å®˜æ–¹ç›´è¿ï¼‰
          wget -q https://dl.google.com/android/repository/android-ndk-r25c-linux.zip -O ndk.zip
          unzip -q -o ndk.zip
          NDK_ROOT=$(pwd)/android-ndk-r25c
          
          # éªŒè¯ NDK å·¥å…·é“¾å®Œæ•´æ€§
          TOOLCHAIN=$NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64
          if [ ! -f "$TOOLCHAIN/bin/aarch64-linux-android24-clang" ] || [ ! -f "$TOOLCHAIN/bin/ld.lld" ]; then
            echo "âŒ NDK å·¥å…·é“¾ç¼ºå¤±ï¼"
            exit 1
          fi
          
          echo "NDK_ROOT=$NDK_ROOT" >> $GITHUB_ENV
          echo "TOOLCHAIN=$TOOLCHAIN" >> $GITHUB_ENV
          chmod -R 777 $NDK_ROOT
          echo "âœ… NDK å‡†å¤‡æˆåŠŸï¼"

      - name: è¡¥å…… Android 5.15 å†…æ ¸å¤´æ–‡ä»¶ï¼ˆè§£å†³å¤´æ–‡ä»¶ç¼ºå¤±ï¼‰
        run: |
          # å…‹éš†è°·æ­Œ 5.15 å†…æ ¸å¤´æ–‡ä»¶ï¼ˆä»…å¤åˆ¶å¿…è¦ç›®å½•ï¼Œé¿å…å†—ä½™ï¼‰
          git clone --depth 1 -b android13-5.15 https://android.googlesource.com/kernel/common.git kernel-src
          KERNEL_HEADERS=$(pwd)/kernel-src/include
          
          # å¤åˆ¶æ ¸å¿ƒå¤´æ–‡ä»¶åˆ°é¡¹ç›®ç›®å½•
          mkdir -p ./kernel-headers
          cp -r $KERNEL_HEADERS/linux ./kernel-headers/
          cp -r $KERNEL_HEADERS/asm-generic ./kernel-headers/
          cp -r $KERNEL_HEADERS/uapi ./kernel-headers/
          cp -r ./kernel-src/arch/arm64/include ./kernel-headers/arch-arm64
          
          # éªŒè¯å…³é”®å¤´æ–‡ä»¶å­˜åœ¨
          [ ! -f "./kernel-headers/linux/kernel.h" ] && { echo "âŒ å†…æ ¸å¤´æ–‡ä»¶ç¼ºå¤±ï¼"; exit 1; }
          [ ! -f "./kernel-headers/arch-arm64/asm/cache.h" ] && { echo "âŒ asm/cache.h ç¼ºå¤±ï¼"; exit 1; }
          
          chmod -R 777 ./kernel-headers
          echo "âœ… å†…æ ¸å¤´æ–‡ä»¶å‡†å¤‡æˆåŠŸï¼"

      - name: ç¼–å†™çº¯æ‰‹åŠ¨ Makefileï¼ˆæ—  kpm.mk ä¾èµ–ï¼‰
        run: |
          cat > ./Makefile << EOF
          # æ¨¡å—åŸºç¡€é…ç½®
          MODULE_NAME := HMA++
          OBJ_NAME := \$(MODULE_NAME).o
          KO_NAME := \$(MODULE_NAME).ko
          KPM_NAME := \$(MODULE_NAME).kpm
          
          # å·¥å…·é“¾é…ç½®ï¼ˆNDK r25c + arm64ï¼‰
          NDK_ROOT := ${{ env.NDK_ROOT }}
          TOOLCHAIN := ${{ env.TOOLCHAIN }}
          CC := \$(TOOLCHAIN)/bin/aarch64-linux-android24-clang
          LD := \$(TOOLCHAIN)/bin/ld.lld
          OBJCOPY := \$(TOOLCHAIN)/bin/llvm-objcopy
          NM := \$(TOOLCHAIN)/bin/llvm-nm
          KERNELDIR := \$(NDK_ROOT)/sysroot
          
          # å¤´æ–‡ä»¶è·¯å¾„ï¼ˆè§£å†³æ‰€æœ‰å¤´æ–‡ä»¶ç¼ºå¤±é—®é¢˜ï¼‰
          INCLUDES := -I./kernel-headers \
                      -I./kernel-headers/arch-arm64 \
                      -I./kernel-headers/arch-arm64/asm \
                      -I./kernel-headers/linux \
                      -I./kernel-headers/asm-generic \
                      -I./kernel-headers/uapi \
                      -I\$(KERNELDIR)/usr/include \
                      -I\$(KERNELDIR)/usr/include/aarch64-linux-android
          
          # ç¼–è¯‘é€‰é¡¹ï¼ˆå…¼å®¹ 5.15 å†…æ ¸ + LLVMï¼‰
          EXTRA_CFLAGS := \$(INCLUDES) \
                          -target aarch64-linux-android \
                          -DKERNEL_5_15 \
                          -D__KERNEL__ \
                          -DMODULE \
                          -Wall -O2 -fPIC -w \
                          -fno-pie -fno-asynchronous-unwind-tables \
                          -mgeneral-regs-only -march=armv8-a \
                          -nostdinc -fno-common
          
          # æ¨¡å—æ„å»ºè§„åˆ™ï¼ˆæ ‡å‡†å†…æ ¸æ¨¡å—ç¼–è¯‘ï¼‰
          obj-m += \$(OBJ_NAME)
          \$(OBJ_NAME): \$(MODULE_NAME).c
              \$(MAKE) -C \$(KERNELDIR) M=\$(PWD) ARCH=arm64 CC=\$(CC) LD=\$(LD) EXTRA_CFLAGS="\$(EXTRA_CFLAGS)" modules
          
          # æ„å»ºç›®æ ‡ï¼ˆè¾“å‡º HMA++.kpmï¼‰
          all: \$(KO_NAME)
              mv \$(KO_NAME) \$(KPM_NAME)
          
          # æ¸…ç†ç›®æ ‡
          clean:
              \$(MAKE) -C \$(KERNELDIR) M=\$(PWD) clean
              rm -f \$(KPM_NAME)
          EOF
          
          # éªŒè¯æºç æ–‡ä»¶å­˜åœ¨
          [ ! -f "./HMA++.c" ] && { echo "âŒ æœªæ‰¾åˆ° HMA++.c æºç æ–‡ä»¶ï¼"; exit 1; }
          chmod 777 ./Makefile ./HMA++.c
          echo "âœ… çº¯æ‰‹åŠ¨ Makefile ç¼–å†™å®Œæˆï¼"

      - name: ç¼–è¯‘ HMA++ KPM æ¨¡å—
        run: |
          # å•çº¿ç¨‹ç¼–è¯‘ï¼ˆé¿å…å¹¶å‘å†²çªï¼Œç¡®ä¿æ—¥å¿—å®Œæ•´ï¼‰
          make -j1 V=1 || { echo "âŒ ç¼–è¯‘å¤±è´¥ï¼"; exit 1; }
          
          # éªŒè¯äº§ç‰©ç”Ÿæˆ
          if [ ! -f "./HMA++.kpm" ]; then
            echo "âŒ ç›®æ ‡äº§ç‰© HMA++.kpm æœªç”Ÿæˆï¼"
            ls -la ./
            exit 1
          fi
          echo "ğŸ‰ HMA++ KPM æ¨¡å—ç¼–è¯‘æˆåŠŸï¼"
          file ./HMA++.kpm

      - name: ä¸Šä¼ äº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: HMA++.kpm
          path: HMA++.kpm
          retention-days: 90
