name: HMA++ KPM Build (KernelPatch Core)
on:
  workflow_dispatch:
    inputs:
      kernel_arch:
        description: "è®¾å¤‡æž¶æž„ï¼ˆarm64/armï¼‰"
        required: true
        default: "arm64"
        type: choice
        options:
          - arm64
          - arm

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout HMA++ æºç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: å®‰è£…åŸºç¡€ä¾èµ–
        run: |
          sudo apt update -y
          sudo apt install -y git wget unzip build-essential clang llvm lld binutils
          sudo apt clean
          chmod -R 777 $(pwd)

      - name: ç›´æŽ¥ä¸‹è½½ KernelPatch æ ¸å¿ƒæž„å»ºæ–‡ä»¶ï¼ˆé¿å…ä»“åº“ç»“æž„ä¾èµ–ï¼‰
        run: |
          # åˆ›å»º kpm ç›®å½•ï¼ˆå­˜æ”¾æ ¸å¿ƒæ–‡ä»¶ï¼‰
          mkdir -p ./kpm
          # ä»Ž KernelPatch ä»“åº“ raw é“¾æŽ¥ä¸‹è½½æ ¸å¿ƒ kpm.mkï¼ˆç¡®ä¿æ–‡ä»¶å­˜åœ¨ï¼‰
          KPM_MK_URL="https://raw.githubusercontent.com/bmax121/KernelPatch/main/kpm/kpm.mk"
          wget -q -O ./kpm/kpm.mk $KPM_MK_URL || {
            # å¤‡ç”¨é“¾æŽ¥ï¼ˆè‹¥ä¸»é“¾æŽ¥å¤±æ•ˆï¼‰
            KPM_MK_URL="https://raw.githubusercontent.com/bmax121/KernelPatch/master/kpm/kpm.mk"
            wget -q -O ./kpm/kpm.mk $KPM_MK_URL || { echo "âŒ kpm.mk ä¸‹è½½å¤±è´¥ï¼"; exit 1; }
          }
          # éªŒè¯æ ¸å¿ƒæ–‡ä»¶
          [ ! -f "./kpm/kpm.mk" ] && { echo "âŒ KernelPatch æ ¸å¿ƒæ–‡ä»¶ç¼ºå¤±ï¼"; exit 1; }
          chmod 777 ./kpm ./kpm/kpm.mk
          echo "âœ… KernelPatch æ ¸å¿ƒæ–‡ä»¶ä¸‹è½½æˆåŠŸï¼"

      - name: ä¸‹è½½ Android NDK r25cï¼ˆç¨³å®šå…¼å®¹ï¼‰
        run: |
          mkdir -p ./ndk
          wget -q https://dl.google.com/android/repository/android-ndk-r25c-linux.zip -O ndk.zip
          unzip -q -o ndk.zip -d ./ndk
          NDK_ROOT=$(pwd)/ndk/android-ndk-r25c
          [ ! -d "$NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64" ] && { echo "âŒ NDK ä¸‹è½½å¤±è´¥ï¼"; exit 1; }
          echo "NDK_ROOT=$NDK_ROOT" >> $GITHUB_ENV
          chmod -R 777 ./ndk
          echo "âœ… NDK å‡†å¤‡æˆåŠŸï¼"

      - name: ç¼–å†™ KernelPatch é…ç½®æ–‡ä»¶ï¼ˆæžç®€é€‚é…ï¼‰
        run: |
          ARCH=${{ github.event.inputs.kernel_arch }}
          # ç”Ÿæˆæ ¸å¿ƒé…ç½®ï¼Œç›´æŽ¥æŒ‡å®šå·¥å…·é“¾è·¯å¾„ï¼ˆä¸ä¾èµ–ä»“åº“å…¶ä»–æ–‡ä»¶ï¼‰
          cat > ./kpm_config.mk << EOF
          NDK_ROOT := ${{ env.NDK_ROOT }}
          ARCH := $ARCH
          # ç¼–è¯‘å™¨é…ç½®ï¼ˆé€‚é… NDK r25c + æž¶æž„ï¼‰
          ifeq (\$(ARCH), arm64)
            TARGET := aarch64-linux-android
            CC := \$(NDK_ROOT)/toolchains/llvm/prebuilt/linux-x86_64/bin/\$(TARGET)24-clang
            LD := \$(NDK_ROOT)/toolchains/llvm/prebuilt/linux-x86_64/bin/ld.lld
            EXTRA_CFLAGS := -target aarch64-linux-android -Wall -O2 -fPIC -w -DKERNEL_5_15 -fno-pie -nostdinc
          else
            TARGET := armv7a-linux-androideabi
            CC := \$(NDK_ROOT)/toolchains/llvm/prebuilt/linux-x86_64/bin/\$(TARGET)24-clang
            LD := \$(NDK_ROOT)/toolchains/llvm/prebuilt/linux-x86_64/bin/ld.lld
            EXTRA_CFLAGS := -target armv7a-linux-androideabi -Wall -O2 -fPIC -w -DKERNEL_5_15 -fno-pie -nostdinc
          endif
          OBJCOPY := \$(NDK_ROOT)/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-objcopy
          NM := \$(NDK_ROOT)/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-nm
          EOF
          chmod 777 ./kpm_config.mk
          echo "âœ… é…ç½®æ–‡ä»¶ç¼–å†™å®Œæˆï¼"

      - name: ç¼–å†™æœ€ç»ˆ Makefileï¼ˆå…¼å®¹ KernelPatch æ ¸å¿ƒé€»è¾‘ï¼‰
        run: |
          cat > ./Makefile << EOF
          # åŒ…å«ä¸‹è½½çš„æ ¸å¿ƒæž„å»ºæ–‡ä»¶
          include ./kpm/kpm.mk
          # å¯¼å…¥é…ç½®
          include ./kpm_config.mk
          
          # æ¨¡å—ä¿¡æ¯
          MODULE_NAME := HMA++
          MODULE_AUTHOR := NightFallsLikeRain
          MODULE_DESCRIPTION := "HMA++ Next: åŸºäºŽç™½åå•çš„åº”ç”¨æ–‡ä»¶æ“ä½œæ‹¦æˆª KPM æ¨¡å—"
          MODULE_LICENSE := GPL-2.0
          MODULE_VERSION := 1.0.0
          
          # æºç æ–‡ä»¶ï¼ˆç”¨æˆ·éœ€ç¡®ä¿ HMA++.c åœ¨æ ¹ç›®å½•ï¼‰
          SRC_FILES := HMA++.c
          
          # åˆå¹¶ç¼–è¯‘é€‰é¡¹
          EXTRA_CFLAGS += -I\$(NDK_ROOT)/sysroot/usr/include -I\$(NDK_ROOT)/sysroot/usr/include/\$(TARGET)
          EOF
          
          [ ! -f "./HMA++.c" ] && { echo "âŒ è¯·å°† HMA++.c æºç æ”¾åœ¨é¡¹ç›®æ ¹ç›®å½•ï¼"; exit 1; }
          chmod 777 ./Makefile ./HMA++.c
          echo "âœ… Makefile é…ç½®å®Œæˆï¼"

      - name: ç¼–è¯‘ HMA++ KPM æ¨¡å—ï¼ˆæœ€ç»ˆæž„å»ºï¼‰
        run: |
          # ç›´æŽ¥ç¼–è¯‘ï¼Œæ ¸å¿ƒæ–‡ä»¶å·²ä¸‹è½½ï¼Œé…ç½®å·²æ˜Žç¡®
          make -j2 V=1 || { echo "âŒ æ¨¡å—ç¼–è¯‘å¤±è´¥ï¼"; exit 1; }
          
          # éªŒè¯æ¨¡å—ç”Ÿæˆ
          if [ -f "./HMA++.ko" ]; then
            echo "ðŸŽ‰ HMA++ KPM æ¨¡å—ç¼–è¯‘æˆåŠŸï¼"
            ls -la ./HMA++.ko
            file ./HMA++.ko
          else
            echo "âŒ æ¨¡å—æ–‡ä»¶æœªç”Ÿæˆï¼"
            exit 1
          fi
          chmod 777 ./HMA++.ko

      - name: ä¸Šä¼ æž„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: HMA++-Next-KPM-${{ github.event.inputs.kernel_arch }}
          path: |
            HMA++.ko
            Makefile
            kpm_config.mk
          retention-days: 90
        if: success()
