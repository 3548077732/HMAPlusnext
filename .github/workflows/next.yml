name: Apatch KPM Build (Kernel 5.15+)
on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘å¼€å…³
    inputs:
      kernel_arch:
        description: "è®¾å¤‡æž¶æž„ï¼ˆarm64/armï¼‰"
        required: true
        default: "arm64"
        type: choice
        options:
          - arm64
          - arm

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      # 1. æ‹‰å–ä»£ç 
      - name: Checkout Code
        uses: actions/checkout@v4

      # 2. å®‰è£…ç¼–è¯‘ä¾èµ–
      - name: Install Dependencies
        run: |
          sudo apt update
          sudo apt install -y build-essential git wget gcc-aarch64-linux-gnu gcc-arm-linux-gnueabihf

      # 3. ä¸‹è½½Apatchå†…æ ¸5.15+é¢„ç¼–è¯‘å¤´æ–‡ä»¶
      - name: Download Kernel 5.15+ Headers
        run: |
          if [ "${{ github.event.inputs.kernel_arch }}" = "arm64" ]; then
            wget https://github.com/apatch-project/apatch-kernel-headers/raw/main/headers-5.15-arm64.tar.gz -O kernel-headers.tar.gz
          else
            wget https://github.com/apatch-project/apatch-kernel-headers/raw/main/headers-5.15-arm.tar.gz -O kernel-headers.tar.gz
          fi
          tar -zxvf kernel-headers.tar.gz -C ./kernel-headers

      # 4. ç¼–è¯‘KPMæ¨¡å—
      - name: Build HMA++ KPM Module
        run: |
          export KERNELDIR=$(pwd)/kernel-headers
          export ARCH=${{ github.event.inputs.kernel_arch }}
          if [ "$ARCH" = "arm64" ]; then
            export CROSS_COMPILE=aarch64-linux-gnu-
          else
            export CROSS_COMPILE=arm-linux-gnueabihf-
          fi
          make -j$(nproc)

      # 5. ä¸Šä¼ ç¼–è¯‘äº§ç‰©ï¼ˆä¾›ä¸‹è½½ï¼‰
      - name: Upload Build Output
        uses: actions/upload-artifact@v4
        with:
          name: HMA++-Next-KPM-${{ github.event.inputs.kernel_arch }}
          path: |
            HMA++.ko
            .config
            Makefile
          retention-days: 90  # äº§ç‰©ä¿ç•™90å¤©
          cd /tmp/kpm
          make -j$(nproc)
          sudo make install
          # éªŒè¯ KPM å®‰è£…
          if ! command -v kpm &> /dev/null; then
            echo "é”™è¯¯ï¼šKPM å·¥å…·å®‰è£…å¤±è´¥ï¼"
            exit 1
          fi
          # å®‰è£…æŒ‡å®šå†…æ ¸å¤´æ–‡ä»¶ï¼ˆå¯é€‰ï¼‰
          if [ -n "${{ github.event.inputs.kernel_version }}" ]; then
            sudo apt install -y linux-headers-${{ github.event.inputs.kernel_version }}
          fi

      - name: âš™ï¸ é…ç½®æž„å»ºå‚æ•°
        run: |
          # è°ƒè¯•æ¨¡å¼æ·»åŠ  -g ç¼–è¯‘é€‰é¡¹
          if [ "${{ github.event.inputs.build_mode }}" = "debug" ]; then
            echo "EXTRA_CFLAGS=-g" >> $GITHUB_ENV
          fi
          # æŒ‡å®š KPM æ¨¡å—å…ƒä¿¡æ¯ï¼ˆä¸Žä»£ç ä¸­ä¸€è‡´ï¼‰
          echo "KPM_NAME=HMA++ Next" >> $GITHUB_ENV
          echo "KPM_VERSION=1.0.12" >> $GITHUB_ENV

      - name: ðŸš€ ç¼–è¯‘å†…æ ¸æ¨¡å—ï¼ˆ.koï¼‰
        run: |
          make clean
          # å¤šçº¿ç¨‹ç¼–è¯‘ï¼Œé€‚é… KPM æ¡†æž¶ç¼–è¯‘è§„åˆ™
          make -j$(nproc) EXTRA_CFLAGS="${{ env.EXTRA_CFLAGS }}"
          # éªŒè¯ .ko æ–‡ä»¶ç”Ÿæˆ
          if [ ! -f "HMA++.ko" ]; then
            echo "é”™è¯¯ï¼šå†…æ ¸æ¨¡å—ç¼–è¯‘å¤±è´¥ï¼"
            exit 1
          fi
          modinfo HMA++.ko  # è¾“å‡ºæ¨¡å—ä¿¡æ¯ï¼ŒéªŒè¯åˆæ³•æ€§

      - name: ðŸ“¦ æ‰“åŒ…ä¸º KPM æ¨¡å—ï¼ˆæ ¸å¿ƒæ­¥éª¤ï¼‰
        run: |
          # ä½¿ç”¨ KPM å·¥å…·æ‰“åŒ… .ko ä¸º .kpmï¼ˆç¬¦åˆ KPM åŠ è½½è§„èŒƒï¼‰
          kpm pack \
            --name "${{ env.KPM_NAME }}" \
            --version "${{ env.KPM_VERSION }}" \
            --author "NightFallsLikeRain" \
            --license "GPLv3" \
            --description "å…¨åº”ç”¨é£Žé™©+å¹¿å‘Šæ‹¦æˆªï¼ˆå«å¾®ä¿¡/QQ/é“¶è¡Œ/ç³»ç»Ÿè½¯ä»¶ç™½åå•ï¼‰" \
            --input "HMA++.ko" \
            --output "HMA++_Next_${{ github.event.inputs.build_mode }}.kpm"
          # éªŒè¯ KPM æ–‡ä»¶ç”Ÿæˆ
          if [ ! -f "HMA++_Next_${{ github.event.inputs.build_mode }}.kpm" ]; then
            echo "é”™è¯¯ï¼šKPM æ¨¡å—æ‰“åŒ…å¤±è´¥ï¼"
            exit 1
          fi
          # è¾“å‡º KPM æ¨¡å—ä¿¡æ¯
          kpm info "HMA++_Next_${{ github.event.inputs.build_mode }}.kpm"

      - name: ðŸ“¤ ä¸Šä¼  KPM äº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: HMA++-Next-KPM-${{ github.event.inputs.build_mode }}
          path: |
            HMA++_Next_${{ github.event.inputs.build_mode }}.kpm  # æ ¸å¿ƒKPMäº§ç‰©
            HMA++.ko  # ä¿ç•™åŽŸå§‹.koï¼Œä¾¿äºŽå¤‡ç”¨
            Makefile  # æž„å»ºé…ç½®æ–‡ä»¶
          retention-days: 90  # äº§ç‰©ä¿ç•™90å¤©ï¼Œæ»¡è¶³é•¿æœŸä½¿ç”¨éœ€æ±‚
          if-no-files-found: error  # æ— äº§ç‰©æ—¶æ ‡è®°æž„å»ºå¤±è´¥

      - name: ðŸ“ æž„å»ºæŠ¥å‘Šï¼ˆå«ä½¿ç”¨è¯´æ˜Žï¼‰
        run: |
          echo "========================================"
          echo "âœ… KPM æ¨¡å—æž„å»ºå®Œæˆï¼"
          echo "ðŸ“Œ æž„å»ºæ¨¡å¼ï¼š${{ github.event.inputs.build_mode }}"
          echo "ðŸ“Œ å†…æ ¸ç‰ˆæœ¬ï¼š${{ github.event.inputs.kernel_version || 'é»˜è®¤ï¼ˆ'$(uname -r)')' }}"
          echo "ðŸ“Œ äº§ç‰©åç§°ï¼šHMA++_Next_${{ github.event.inputs.build_mode }}.kpm"
          echo "ðŸ“Œ åŠ è½½å‘½ä»¤ï¼škpm load HMA++_Next_${{ github.event.inputs.build_mode }}.kpm"
          echo "ðŸ“Œ æŽ§åˆ¶å‘½ä»¤ï¼šecho '1,1' > /proc/kpmctl/HMA++ Next"
          echo "ðŸ“Œ æ—¥å¿—æŸ¥çœ‹ï¼šdmesg | grep [HMA++]"
          echo "========================================"
