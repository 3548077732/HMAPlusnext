name: Build2

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout HMA++ æºç 
        uses: actions/checkout@v5

      - name: å®‰è£…å®Œæ•´ç¼–è¯‘ä¾èµ–ï¼ˆæ— é¢å¤–å†—ä½™ï¼‰
        run: |
          sudo apt update -y && sudo apt install -y \
            build-essential clang llvm lld binutils \
            wget unzip libssl-dev libelf-dev git  # ä»…ä¿ç•™å¿…éœ€ä¾èµ–
          sudo apt clean
          echo "âœ… ä¾èµ–å®‰è£…å®Œæˆï¼"

      - name: ä¸‹è½½å¹¶é…ç½® NDK r25cï¼ˆæ ¸å¿ƒå·¥å…·é“¾ï¼‰
        run: |
          echo "ğŸ“¥ ä¸‹è½½ Android NDK r25cï¼ˆå®˜æ–¹é«˜é€Ÿé“¾æ¥ï¼‰"
          wget -q https://dl.google.com/android/repository/android-ndk-r25c-linux.zip -O ndk.zip
          echo "ğŸ“¦ è§£å‹ NDK..."
          unzip -q -o ndk.zip
          NDK_ROOT=$(pwd)/android-ndk-r25c
          
          # éªŒè¯å·¥å…·é“¾å®Œæ•´æ€§
          TOOLCHAIN=$NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64
          if [ ! -f "$TOOLCHAIN/bin/aarch64-linux-android24-clang" ] || [ ! -f "$TOOLCHAIN/bin/ld.lld" ]; then
            echo "âŒ NDK å·¥å…·é“¾ç¼ºå¤±ï¼"
            exit 1
          fi
          
          # é…ç½®ç¯å¢ƒå˜é‡
          echo "NDK_ROOT=$NDK_ROOT" >> $GITHUB_ENV
          echo "TOOLCHAIN=$TOOLCHAIN" >> $GITHUB_ENV
          chmod -R 777 $NDK_ROOT
          echo "âœ… NDK å‡†å¤‡æˆåŠŸï¼è·¯å¾„ï¼š$NDK_ROOT"

      - name: å…‹éš† Android 5.15 å†…æ ¸å¤´æ–‡ä»¶ï¼ˆè§£å†³æ‰€æœ‰å¤´æ–‡ä»¶ä¾èµ–ï¼‰
        run: |
          echo "ğŸ“¥ å…‹éš†å†…æ ¸æ ¸å¿ƒå¤´æ–‡ä»¶ï¼ˆä»…å¿…è¦ç›®å½•ï¼Œæé€Ÿï¼‰"
          git clone --depth 1 -b android13-5.15 https://android.googlesource.com/kernel/common.git kernel-src
          mkdir -p ./kernel-headers
          
          # å¤åˆ¶æ ¸å¿ƒå¤´æ–‡ä»¶ï¼ˆè¦†ç›–æ‰€æœ‰å†…æ ¸ä¾èµ–ï¼‰
          cp -r kernel-src/include/linux ./kernel-headers/
          cp -r kernel-src/include/asm-generic ./kernel-headers/
          cp -r kernel-src/include/uapi ./kernel-headers/
          cp -r kernel-src/arch/arm64/include ./kernel-headers/arch-arm64
          cp -r kernel-src/arch/arm64/include/asm ./kernel-headers/arch-arm64/asm
          
          # éªŒè¯å…³é”®å¤´æ–‡ä»¶
          [ ! -f "./kernel-headers/linux/kernel.h" ] && { echo "âŒ å†…æ ¸å¤´æ–‡ä»¶ç¼ºå¤±ï¼"; exit 1; }
          [ ! -f "./kernel-headers/arch-arm64/asm/cache.h" ] && { echo "âŒ asm/cache.h ç¼ºå¤±ï¼"; exit 1; }
          
          chmod -R 777 ./kernel-headers
          echo "âœ… å†…æ ¸å¤´æ–‡ä»¶å‡†å¤‡æˆåŠŸï¼"

      - name: ç”Ÿæˆçº¯æ‰‹åŠ¨ Makefileï¼ˆæ— ä»»ä½•ç¬¬ä¸‰æ–¹ä¾èµ–ï¼‰
        run: |
          cat > ./Makefile << EOF
          # çº¯æ‰‹åŠ¨ç¼–è¯‘ Makefileï¼ˆæ—  kpm.mkï¼Œæ—  KernelPatchï¼‰
          MODULE_NAME := HMA++
          OBJ_NAME := \$(MODULE_NAME).o
          KO_NAME := \$(MODULE_NAME).ko
          KPM_NAME := \$(MODULE_NAME).kpm

          # å·¥å…·é“¾é…ç½®ï¼ˆä»ç¯å¢ƒå˜é‡è¯»å–ï¼‰
          NDK_ROOT ?= \$(ENV{NDK_ROOT})
          TOOLCHAIN ?= \$(ENV{TOOLCHAIN})
          CC := \$(TOOLCHAIN)/bin/aarch64-linux-android24-clang
          LD := \$(TOOLCHAIN)/bin/ld.lld
          KERNELDIR := \$(NDK_ROOT)/sysroot

          # å¤´æ–‡ä»¶è·¯å¾„ï¼ˆè¦†ç›–æ‰€æœ‰ä¾èµ–ï¼Œæ— é—æ¼ï¼‰
          INCLUDES := -I./kernel-headers \
                      -I./kernel-headers/arch-arm64 \
                      -I./kernel-headers/arch-arm64/asm \
                      -I./kernel-headers/linux \
                      -I./kernel-headers/asm-generic \
                      -I./kernel-headers/uapi \
                      -I\$(KERNELDIR)/usr/include \
                      -I\$(KERNELDIR)/usr/include/aarch64-linux-android

          # ç¼–è¯‘é€‰é¡¹ï¼ˆé€‚é… 5.15 å†…æ ¸ arm64ï¼Œå…¼å®¹ LLVMï¼‰
          EXTRA_CFLAGS := \$(INCLUDES) \
                          -target aarch64-linux-android \
                          -DKERNEL_5_15 \
                          -D__KERNEL__ \
                          -DMODULE \
                          -Wall -O2 -fPIC -w \
                          -fno-pie -fno-asynchronous-unwind-tables \
                          -mgeneral-regs-only -march=armv8-a \
                          -nostdinc -fno-common \
                          -Wno-implicit-function-declaration \
                          -Wno-incompatible-pointer-types

          # æ¨¡å—ç¼–è¯‘è§„åˆ™ï¼ˆæ— ç¼©è¿›ï¼Œè¯­æ³•é›¶é”™è¯¯ï¼‰
          obj-m += \$(OBJ_NAME)
          \$(OBJ_NAME): \$(MODULE_NAME).c; \$(MAKE) -C \$(KERNELDIR) M=\$(PWD) ARCH=arm64 CC=\$(CC) LD=\$(LD) EXTRA_CFLAGS="\$(EXTRA_CFLAGS)" modules

          # æ„å»ºç›®æ ‡ï¼ˆäº§ç‰©é‡å‘½åä¸º HMA++.kpmï¼‰
          all: \$(KO_NAME); mv \$(KO_NAME) \$(KPM_NAME); echo "âœ… ç¼–è¯‘å®Œæˆï¼äº§ç‰©ï¼š\$(KPM_NAME)"

          # æ¸…ç†ç›®æ ‡
          clean:; \$(MAKE) -C \$(KERNELDIR) M=\$(PWD) clean; rm -rf \$(KPM_NAME) *.mod.c *.o .*.cmd Module.symvers modules.order .tmp_versions; echo "âœ… æ¸…ç†å®Œæˆï¼"

          .PHONY: all clean
          EOF
          
          # éªŒè¯æºç æ–‡ä»¶å­˜åœ¨
          [ ! -f "./HMA++.c" ] && { echo "âŒ æœªæ‰¾åˆ° HMA++.c æºç æ–‡ä»¶ï¼"; exit 1; }
          chmod 777 ./Makefile ./HMA++.c
          echo "âœ… çº¯æ‰‹åŠ¨ Makefile ç”Ÿæˆå®Œæˆï¼"

      - name: ç¼–è¯‘ HMA++ æ¨¡å—ï¼ˆè¯¦ç»†æ—¥å¿—ï¼Œä¾¿äºæ’é”™ï¼‰
        run: |
          echo "ğŸ”¨ å¼€å§‹ç¼–è¯‘æ¨¡å—..."
          make V=1 || { echo "âŒ ç¼–è¯‘å¤±è´¥ï¼"; exit 1; }

      - name: éªŒè¯äº§ç‰©å­˜åœ¨
        run: |
          if [ ! -f "./HMA++.kpm" ]; then
            echo "âŒ ç›®æ ‡äº§ç‰© HMA++.kpm æœªç”Ÿæˆï¼"
            ls -la ./
            exit 1
          fi
          echo "âœ… äº§ç‰©éªŒè¯æˆåŠŸï¼"

      - name: ä¸Šä¼ äº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: HMA++.kpm
          path: HMA++.kpm
          retention-days: 90
